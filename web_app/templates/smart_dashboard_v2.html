<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Digital Twin - Unified Intelligence Workspace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Enterprise Color Palette */
            --primary-blue: #0078d4;
            --primary-blue-dark: #005a9e;
            --primary-blue-light: #40e0d0;
            --secondary-blue: #4285f4;
            --dark-blue: #1a365d;
            --navy-blue: #2c5aa0;
            
            /* Enterprise Neutrals */
            --enterprise-bg: #f4f6f8;
            --sidebar-bg: #1e293b;
            --card-bg: #fafbfc;
            --surface-bg: #f1f3f5;
            --border-color: #e1e5e9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            
            /* Status Colors */
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;
            
            /* Glass Morphism - Enterprise */
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(226, 232, 240, 0.8);
            --glass-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            
            /* Shadows - Subtle Enterprise */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body {
            background: var(--enterprise-bg);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.5;
        }

        .main-content {
            margin-left: 0;
            min-height: 100vh;
            padding: 24px;
        }

        /* Enterprise Cards */
        .glass-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            transition: all 0.2s ease;
            backdrop-filter: blur(20px);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-blue);
        }

        /* Command Center Header */
        .command-center {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
        }

        .command-input {
            background: var(--surface-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 400;
            transition: all 0.2s ease;
        }

        .command-input:focus {
            background: var(--card-bg);
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
            color: var(--text-primary);
            outline: none;
        }

        .command-input::placeholder {
            color: var(--text-muted);
            font-weight: 400;
        }


        /* Tool Panel Styles */
        .tool-panel {
            padding: 20px;
        }

        .results-area {
            min-height: 200px;
            padding: 16px;
            background: var(--surface-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 16px;
        }

        .results-area:empty::before {
            content: "Results will appear here...";
            color: var(--text-muted);
            font-style: italic;
        }

        .workspace-header .btn {
            font-size: 14px;
            padding: 8px 16px;
        }

        .work-panel {
            box-shadow: var(--shadow-sm);
        }

        .results-panel {
            box-shadow: var(--shadow-sm);
        }

        /* Removed voice command center from screen center */

        .voice-btn {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background: var(--primary-blue);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn:hover {
            background: var(--primary-blue-dark);
            transform: scale(1.05);
        }

        .voice-btn.recording {
            background: var(--error-color);
            animation: recording-pulse 2s infinite;
        }

        @keyframes recording-pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Intelligent Cards */
        .intelligence-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            grid-template-rows: auto auto;
            gap: 24px;
            height: calc(100vh - 180px);
            padding: 0 96px 0 24px;
        }

        .main-workspace {
            grid-column: 1;
            grid-row: 1 / 3;
        }

        .ai-insights {
            grid-column: 2;
            grid-row: 1;
        }

        .collaboration-hub {
            grid-column: 2;
            grid-row: 2;
        }

        /* Document Workspace */
        .document-workspace {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .document-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .doc-tab {
            padding: 10px 16px;
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
        }

        .doc-tab:hover {
            background: var(--surface-bg);
            color: var(--text-primary);
        }

        .doc-tab.active {
            background: var(--primary-blue);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 120, 212, 0.2);
        }

        /* Enterprise AI Insights Panel */
        .insight-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .insight-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-blue);
            transform: translateY(-1px);
        }

        /* Enterprise Collaboration Hub */
        .collab-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 12px;
            color: var(--text-primary);
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .collab-item:hover {
            background: var(--surface-bg);
            border-color: var(--primary-blue);
        }

        /* Enterprise Status Indicators */
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.bg-success {
            background-color: var(--success-color) !important;
        }

        .status-indicator.bg-warning {
            background-color: var(--warning-color) !important;
        }

        .status-indicator.bg-danger {
            background-color: var(--error-color) !important;
        }

        .status-indicator.bg-secondary {
            background-color: var(--text-muted) !important;
        }

        /* Enterprise Buttons */
        .btn-primary {
            background-color: var(--primary-blue);
            border-color: var(--primary-blue);
            font-weight: 500;
        }

        .btn-primary:hover {
            background-color: var(--primary-blue-dark);
            border-color: var(--primary-blue-dark);
        }

        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
            font-weight: 500;
        }

        .btn-outline-light {
            color: var(--text-secondary);
            border-color: var(--border-color);
            background-color: transparent;
        }

        .btn-outline-light:hover {
            color: var(--primary-blue);
            border-color: var(--primary-blue);
            background-color: rgba(0, 120, 212, 0.05);
        }

        /* Enterprise Notification Animation */
        .smart-notification.show {
            transform: translateX(0) !important;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--success-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-weight: bold;
        }

        /* Real-time indicators */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #38ef7d;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* Smart notifications */
        .smart-notification {
            position: fixed;
            top: 20px;
            right: 120px;
            background: var(--dark-gradient);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            transform: translateX(400px);
            transition: transform 0.4s ease;
            z-index: 1060;
        }

        .smart-notification.show {
            transform: translateX(0);
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .intelligence-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .main-workspace {
                grid-column: 1;
                grid-row: 1;
            }
            
            .ai-insights {
                grid-column: 1;
                grid-row: 2;
            }
            
            .collaboration-hub {
                grid-column: 1;
                grid-row: 3;
            }
            
            .smart-sidebar {
                position: relative;
                width: 100%;
                height: auto;
                margin-bottom: 20px;
            }
        }

        /* Loading animations */
        .loading-shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Context-aware highlights */
        .context-highlight {
            border-left: 4px solid #38ef7d;
            background: rgba(56, 239, 125, 0.1);
        }

        .urgent-highlight {
            border-left: 4px solid #f5576c;
            background: rgba(245, 87, 108, 0.1);
        }

        /* Notification Panel */
        .notification-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1050;
            display: none;
            overflow: hidden;
        }

        .notification-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-bg);
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: background-color 0.2s ease;
        }

        .notification-item:hover {
            background: var(--surface-bg);
        }

        .notification-item.unread {
            background: rgba(0, 120, 212, 0.05);
            border-left: 3px solid var(--primary-blue);
        }

        .notification-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .notification-icon.success { background: var(--success-color); color: white; }
        .notification-icon.error { background: var(--error-color); color: white; }
        .notification-icon.info { background: var(--info-color); color: white; }
        .notification-icon.warning { background: var(--warning-color); color: white; }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .notification-text {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.4;
        }

        .notification-time {
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 4px;
        }

        /* Progress Console */
        .progress-console {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            max-height: 300px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1040;
            display: none;
        }

        .console-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-bg);
            display: flex;
            justify-content: between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }

        .console-content {
            max-height: 250px;
            overflow-y: auto;
            padding: 12px;
        }

        .console-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .console-item:last-child {
            border-bottom: none;
        }

        .console-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .console-icon.processing {
            background: var(--info-color);
            animation: pulse 1.5s infinite;
        }

        .console-icon.completed {
            background: var(--success-color);
        }

        .console-icon.error {
            background: var(--error-color);
        }

        .console-text {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
        }

        .console-time {
            color: var(--text-muted);
            font-size: 12px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes bounce {
            0%, 20%, 60%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            80% {
                transform: translateY(-5px);
            }
        }
    </style>
</head>
<body>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Command Center Header -->
        <div class="container-fluid">
        <div class="command-center">
            <div class="d-flex align-items-center justify-content-between">
                <div style="flex: 1; margin-right: 20px;">
                    <h3 class="mb-3" style="color: var(--text-primary); font-weight: 600;">
                        <i class="fas fa-brain me-2" style="color: var(--primary-blue);"></i>
                        Unified Intelligence Workspace
                    </h3>
                    <div class="input-group">
                        <input type="text" class="command-input form-control" 
                               placeholder="Ask me anything, upload files, or give voice commands..." 
                               id="commandInput">
                        <button class="btn btn-primary" style="border-radius: 0 12px 12px 0; padding: 16px 24px;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-4">
                    <div class="text-center">
                        <div class="status-indicator bg-success mx-auto mb-1"></div>
                        <small style="color: var(--text-secondary); font-weight: 500;">AI Active</small>
                    </div>
                    <div class="text-center">
                        <i class="fas fa-users" style="color: var(--success-color); font-size: 20px;"></i>
                        <br><small style="color: var(--text-secondary); font-weight: 500;">2 users (Jarvis and you)</small>
                    </div>
                    <div class="text-center">
                        <button class="btn btn-link p-0" onclick="window.dashboard.showCollaborationInterface()" style="color: var(--primary-blue); font-size: 20px; border: none; background: none;" title="Collaboration Intelligence">
                            <i class="fas fa-users-cog"></i>
                        </button>
                        <br><small style="color: var(--text-secondary); font-weight: 500;">Collaboration</small>
                    </div>
                    <div class="text-center position-relative">
                        <button class="btn btn-link p-0" onclick="window.dashboard.toggleNotificationPanel()" style="color: var(--info-color); font-size: 20px; border: none; background: none;" title="View Notifications">
                            <i class="fas fa-bell" id="notificationBell"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">0</span>
                        </button>
                        <br><small style="color: var(--text-secondary); font-weight: 500;">Notifications</small>
                    </div>
                    <div class="text-center">
                        <i class="fas fa-clock" style="color: var(--info-color); font-size: 20px;"></i>
                        <br><small id="currentTime" style="color: var(--text-secondary); font-weight: 500;">14:30</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Intelligence Grid -->
    <div class="container-fluid px-4">
        <div class="intelligence-grid">
            
            <!-- Main Workspace -->
            <div class="main-workspace">
                <div class="glass-card h-100">
                    <div class="document-workspace">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0" style="color: var(--text-primary); font-weight: 600;">
                                <i class="fas fa-layer-group me-2" style="color: var(--primary-blue);"></i>
                                AI Intelligence Workspace
                            </h5>
                        </div>

                        <!-- Workspace Header -->
                        <div class="workspace-header d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="window.dashboard.showToolPanel('analysis')">
                                    <i class="fas fa-search me-1"></i>Analysis
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="window.dashboard.showToolPanel('questions')">
                                    <i class="fas fa-question-circle me-1"></i>Questions
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="window.dashboard.showToolPanel('email')">
                                    <i class="fas fa-envelope me-1"></i>Email
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="window.dashboard.showToolPanel('meeting')">
                                    <i class="fas fa-microphone me-1"></i>Meeting
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="window.dashboard.showToolPanel('blog')">
                                    <i class="fas fa-edit me-1"></i>Blog
                                </button>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="window.dashboard.toggleResultsPanel()">
                                    <i class="fas fa-history me-1"></i>History
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="window.dashboard.clearWorkspace()">
                                    <i class="fas fa-trash me-1"></i>Clear
                                </button>
                            </div>
                        </div>

                        <!-- Main Workspace Layout -->
                        <div class="workspace-layout" style="height: calc(100% - 60px); display: flex; gap: 20px;">
                            <!-- Active Work Panel -->
                            <div class="work-panel" style="flex: 1; background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border-color); padding: 32px; overflow-y: auto; min-height: 600px;">
                                <div id="activeWorkArea">
                                    <div class="text-center py-5">
                                        <i class="fas fa-rocket" style="font-size: 4rem; color: var(--primary-blue); margin-bottom: 24px;"></i>
                                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">Welcome to Your AI Workspace</h3>
                                        <p style="color: var(--text-secondary); font-size: 1.1rem; max-width: 600px; margin: 0 auto;">Select a tool above to get started with document analysis, meeting processing, or content generation. Your AI-powered workspace is ready for any task.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Results/Library Panel -->
                            <div class="results-panel" id="resultsPanel" style="width: 420px; background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border-color); padding: 24px; overflow-y: auto; display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 style="color: var(--text-primary); margin: 0; font-weight: 600;">Results & History</h5>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="window.dashboard.toggleResultsPanel()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div id="resultsContent">
                                    <p style="color: var(--text-secondary);">Your analysis results and history will appear here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Insights Panel -->
            <div class="ai-insights">
                <div class="glass-card h-100 p-4">
                    <h5 class="text-white mb-4">
                        <i class="fas fa-robot me-2 text-success"></i>
                        AI Intelligence
                    </h5>

                    <div class="insight-card context-highlight">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-brain text-success me-3"></i>
                            <h6 class="mb-0">Context Analysis</h6>
                        </div>
                        <p class="small mb-0">Meeting about Q4 strategy. Detected: 3 speakers, 15 action items, high engagement level.</p>
                    </div>

                    <!-- Voice Assistant Widget -->
                    <div class="insight-card" id="voiceWidget">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-microphone text-info me-3"></i>
                                <h6 class="mb-0">Voice Assistant</h6>
                            </div>
                            <div class="status-indicator" id="voiceStatus" style="background: #6c757d;"></div>
                        </div>
                        
                        <div class="d-flex gap-2 mb-2">
                            <button class="btn btn-outline-info btn-sm flex-fill" id="voiceToggleBtn" onclick="window.dashboard.toggleVoiceRecording()">
                                <i class="fas fa-microphone me-1"></i>
                                Start
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="window.dashboard.clearVoiceTranscript()" title="Clear Transcript">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <div id="voiceTranscriptPreview" class="small text-muted" style="max-height: 60px; overflow-y: auto; border-radius: 6px; padding: 8px; background: rgba(255,255,255,0.05);">
                            Ready to listen...
                        </div>
                    </div>

                    <div class="insight-card">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-chart-trending-up text-warning me-3"></i>
                            <h6 class="mb-0">Productivity Score</h6>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="progress" style="height: 8px; width: 100%;">
                                <div class="progress-bar bg-success" style="width: 85%"></div>
                            </div>
                            <span class="ms-2 small">85%</span>
                        </div>
                    </div>

                    <div class="insight-card urgent-highlight">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-exclamation-triangle text-warning me-3"></i>
                            <h6 class="mb-0">Urgent Actions</h6>
                        </div>
                        <p class="small mb-0">3 deadlines approaching this week. Review budget proposal by Friday.</p>
                    </div>

                    <div class="insight-card">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-lightbulb text-info me-3"></i>
                            <h6 class="mb-0">Smart Recommendations</h6>
                        </div>
                        <ul class="small mb-0 ps-3" id="smartRecommendationsList">
                            <li>Loading recommendations...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Collaboration Hub -->
            <div class="collaboration-hub">
                <div class="glass-card h-100 p-4">
                    <h5 class="text-white mb-4">
                        <i class="fas fa-users me-2 text-info"></i>
                        Live Collaboration
                    </h5>

                    <div class="collab-item">
                        <div class="avatar">S</div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <strong>Sarah Johnson</strong>
                                <span class="status-indicator"></span>
                            </div>
                            <small class="text-muted">Reviewing Q4 budget now</small>
                        </div>
                    </div>

                    <div class="collab-item">
                        <div class="avatar">M</div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <strong>Mike Chen</strong>
                                <span class="status-indicator"></span>
                            </div>
                            <small class="text-muted">Working on strategy doc</small>
                        </div>
                    </div>

                    <div class="collab-item">
                        <div class="avatar">AI</div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <strong>AI Assistant</strong>
                                <span class="status-indicator"></span>
                            </div>
                            <small class="text-muted">Processing meeting insights</small>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6 class="text-white mb-3">Recent Activity</h6>
                        <div class="small text-muted">
                            <div class="mb-2">
                                <i class="fas fa-file-upload text-success me-2"></i>
                                Sarah uploaded budget_v2.xlsx
                            </div>
                            <div class="mb-2">
                                <i class="fas fa-comment text-info me-2"></i>
                                Mike commented on strategy doc
                            </div>
                            <div class="mb-2">
                                <i class="fas fa-microphone text-warning me-2"></i>
                                Voice meeting started (5 mins ago)
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Voice Command Center -->
    <!-- Voice command center removed - using sidebar widget instead -->

    <!-- Enterprise Smart Notifications -->
    <div class="smart-notification" id="smartNotification" style="
        position: fixed;
        top: 24px;
        right: 24px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        box-shadow: var(--shadow-lg);
        z-index: 1060;
        min-width: 320px;
        transform: translateX(400px);
        transition: transform 0.3s ease;
    ">
        <div class="d-flex align-items-start">
            <i class="fas fa-bell me-3" style="color: var(--primary-blue); margin-top: 2px;"></i>
            <div>
                <strong style="color: var(--text-primary);">AI Insight</strong>
                <div class="small" style="color: var(--text-secondary);">Meeting summary is ready for review</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/voice_processor.js"></script>
    <script>
        // Smart Dashboard Controller
        class SmartDashboard {
            constructor() {
                this.isVoiceActive = false;
                this.currentContext = 'meeting';
                this.voiceProcessor = null;
                this.documents = new Map();
                this.collaborators = new Map();
                this.transcriptBuffer = [];
                this.pollingActive = false;
                this.ws = null;
                this.init();
            }

            init() {
                this.updateTime();
                this.setupEventListeners();
                this.initializeVoiceProcessor();
                this.loadExistingData();
                this.startContextualUpdates();
                this.setupWebSockets();
                setInterval(() => this.updateTime(), 1000);
            }

            async initializeVoiceProcessor() {
                try {
                    if (typeof VoiceProcessor !== 'undefined') {
                        this.voiceProcessor = new VoiceProcessor('http://localhost:8001');
                        console.log('✅ Voice processor integrated with smart dashboard');
                        
                        // Set up event listeners for voice widget integration
                        window.addEventListener('voiceRecordingStatus', (event) => {
                            const { isRecording } = event.detail;
                            const status = document.getElementById('voiceStatus');
                            const btn = document.getElementById('voiceToggleBtn');
                            
                            if (isRecording) {
                                status.style.background = '#dc3545';
                                status.style.animation = 'blink 1s infinite';
                                btn.innerHTML = '<i class="fas fa-stop me-1"></i>Stop';
                                btn.className = 'btn btn-outline-danger btn-sm flex-fill';
                            } else {
                                status.style.background = '#6c757d';
                                status.style.animation = 'none';
                                btn.innerHTML = '<i class="fas fa-microphone me-1"></i>Start';
                                btn.className = 'btn btn-outline-info btn-sm flex-fill';
                            }
                        });
                        
                        // Listen for voice transcription results
                        window.addEventListener('voiceTranscription', (event) => {
                            const { text } = event.detail;
                            this.updateVoicePreview(text);
                        });
                        
                    } else {
                        console.warn('⚠️ VoiceProcessor not available, using fallback');
                    }
                } catch (error) {
                    console.error('❌ Voice processor initialization failed:', error);
                }
            }

            async loadExistingData() {
                // Load all real data in parallel
                await Promise.all([
                    this.loadRealDocuments(),
                    this.loadRealBehavioralData(),
                    this.loadRealStatistics(),
                    this.loadRealMemories(),
                    this.loadSmartRecommendations(),
                    this.initializeJarvis()
                ]);
            }

            async loadRealDocuments() {
                try {
                    const [recentActivity, documents, tasks] = await Promise.all([
                        fetch('/recent-activity').then(r => r.ok ? r.json() : []).catch(() => []),
                        fetch('/documents').then(r => r.ok ? r.json() : []).catch(() => []),
                        fetch('/tasks').then(r => r.ok ? r.json() : []).catch(() => [])
                    ]);

                    // Also get activities from localStorage
                    const localActivities = JSON.parse(localStorage.getItem('workspaceActivities') || '[]');
                    const combinedActivities = [...localActivities, ...recentActivity];

                    // Update documents display
                    const docArea = document.querySelector('#activeDocument');
                    if (docArea) {
                        let docsHtml = '';
                        
                        if (documents.length > 0) {
                            docsHtml = `
                                <div class="mb-3">
                                    <h6 class="text-warning">📄 Recent Documents</h6>
                                    <div class="p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                                        ${documents.slice(0, 5).map(doc => `
                                            <div class="d-flex align-items-center mb-2 document-item" onclick="window.dashboard.openDocument('${doc.id}')">
                                                <i class="fas fa-file-${this.getFileIcon(doc.name)} me-3"></i>
                                                <span>${doc.name || 'Untitled'}</span>
                                                <span class="ms-auto text-muted">${doc.size || 'Unknown size'}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }

                        if (tasks.length > 0) {
                            const activeTasks = tasks.filter(task => task.status === 'processing');
                            if (activeTasks.length > 0) {
                                docsHtml += `
                                    <div class="mb-3">
                                        <h6 class="text-info">⚙️ Processing Tasks</h6>
                                        <div class="p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                                            ${activeTasks.map(task => `
                                                <div class="d-flex align-items-center mb-2">
                                                    <div class="spinner-border spinner-border-sm me-3"></div>
                                                    <span>${task.action || 'Processing'}</span>
                                                    <span class="ms-auto text-muted">${task.progress || '0'}%</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                        }

                        if (combinedActivities.length > 0) {
                            docsHtml += `
                                <div class="mb-3">
                                    <h6 class="text-success">📊 Recent Activity</h6>
                                    <div class="p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                                        ${combinedActivities.slice(0, 3).map(activity => `
                                            <div class="mb-2">
                                                <i class="fas fa-${this.getActivityIcon(activity.type || 'file')} text-${this.getActivityColor(activity.type || 'info')} me-2"></i>
                                                ${activity.description || activity.action || activity.filename || 'Processing activity'}
                                                <small class="text-muted d-block">${activity.timestamp ? new Date(activity.timestamp).toLocaleString() : 'Recent'}</small>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }

                        if (!docsHtml) {
                            docsHtml = `
                                <div class="text-center py-4">
                                    <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                                    <p class="text-white">Drop files here or use the command bar above</p>
                                    <small class="text-muted">Supports PDF, DOCX, TXT and more</small>
                                </div>
                            `;
                        }

                        docArea.innerHTML = docsHtml;
                    }
                } catch (error) {
                    console.error('Failed to load documents:', error);
                }
            }

            async loadRealBehavioralData() {
                try {
                    const [behavioralInsights, statistics] = await Promise.all([
                        fetch('/behavioral-insights/Paresh').then(r => r.ok ? r.json() : null).catch(() => null),
                        fetch('/statistics').then(r => r.ok ? r.json() : null).catch(() => null)
                    ]);

                    // Update command center stats
                    if (behavioralInsights) {
                        const statusDiv = document.querySelector('.command-center .d-flex.align-items-center.gap-3');
                        if (statusDiv) {
                            statusDiv.innerHTML = `
                                <div class="text-white text-center">
                                    <div class="status-indicator mx-auto mb-1"></div>
                                    <small>AI Active</small>
                                </div>
                                <div class="text-white text-center">
                                    <i class="fas fa-chart-line" style="color: #38ef7d; font-size: 20px;"></i>
                                    <br><small>${behavioralInsights.productivity_score || 0}% Productive</small>
                                </div>
                                <div class="text-white text-center">
                                    <i class="fas fa-brain" style="color: #667eea; font-size: 20px;"></i>
                                    <br><small>${behavioralInsights.focus_sessions || 0} Focus</small>
                                </div>
                                <div class="text-white text-center">
                                    <i class="fas fa-clock" style="color: #667eea; font-size: 20px;"></i>
                                    <br><small id="currentTime">14:30</small>
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    console.error('Failed to load behavioral data:', error);
                }
            }

            async loadRealStatistics() {
                try {
                    const stats = await fetch('/statistics').then(r => r.ok ? r.json() : null).catch(() => null);
                    
                    if (stats && stats.overview) {
                        // Store stats for later use
                        this.systemStats = stats;
                        console.log('📊 System statistics loaded:', stats.overview);
                    }
                } catch (error) {
                    console.error('Failed to load statistics:', error);
                }
            }

            async loadRealMemories() {
                try {
                    const memories = await fetch('/memories?limit=5').then(r => r.ok ? r.json() : []).catch(() => []);
                    this.recentMemories = memories;
                    console.log('🧠 Recent memories loaded:', memories.length);
                } catch (error) {
                    console.error('Failed to load memories:', error);
                }
            }

            async loadSmartRecommendations() {
                try {
                    // Try to get recommendations from collaboration API
                    const response = await fetch('http://localhost:8001/suggestions/pending').catch(() => null);
                    let recommendations = [];
                    
                    if (response && response.ok) {
                        const data = await response.json();
                        recommendations = data.suggestions.slice(0, 3).map(s => s.title);
                    }
                    
                    // Fallback to intelligent recommendations based on context
                    if (recommendations.length === 0) {
                        const currentTime = new Date();
                        const dayOfWeek = currentTime.getDay();
                        const hour = currentTime.getHours();
                        
                        if (dayOfWeek === 1) { // Monday
                            recommendations = [
                                "Plan your week's priorities",
                                "Review pending tasks from last week", 
                                "Schedule team check-ins"
                            ];
                        } else if (dayOfWeek === 5) { // Friday
                            recommendations = [
                                "Complete week review",
                                "Document lessons learned",
                                "Plan next week's objectives"
                            ];
                        } else if (hour < 12) { // Morning
                            recommendations = [
                                "Review today's scheduled meetings",
                                "Process urgent emails",
                                "Focus on high-impact tasks"
                            ];
                        } else { // Afternoon
                            recommendations = [
                                "Update project status",
                                "Follow up on pending items",
                                "Prepare for tomorrow"
                            ];
                        }
                    }
                    
                    // Update the UI
                    const listElement = document.getElementById('smartRecommendationsList');
                    if (listElement) {
                        listElement.innerHTML = recommendations.map(rec => `<li>${rec}</li>`).join('');
                    }
                    
                    console.log('💡 Smart recommendations loaded:', recommendations.length);
                } catch (error) {
                    console.error('Failed to load smart recommendations:', error);
                    const listElement = document.getElementById('smartRecommendationsList');
                    if (listElement) {
                        listElement.innerHTML = '<li>Review your current priorities</li><li>Complete pending tasks</li><li>Plan your next steps</li>';
                    }
                }
            }

            async initializeJarvis() {
                try {
                    // Initialize Jarvis AI Agent
                    this.jarvis = {
                        status: 'online',
                        lastSeen: new Date(),
                        currentTask: 'Monitoring your productivity',
                        messageHistory: []
                    };

                    // Load Jarvis interface
                    const container = document.querySelector('.collaboration-hub .glass-card');
                    if (container) {
                        container.innerHTML = `
                            <h5 class="text-white mb-4">
                                <i class="fas fa-robot me-2 text-success"></i>
                                Jarvis AI Assistant
                            </h5>

                            <!-- Jarvis Status -->
                            <div class="collab-item" style="background: rgba(56, 239, 125, 0.2);">
                                <div class="avatar" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">J</div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <strong>Jarvis</strong>
                                        <span class="status-indicator"></span>
                                    </div>
                                    <small class="text-success">${this.jarvis.currentTask}</small>
                                </div>
                            </div>

                            <!-- Chat Interface -->
                            <div class="mt-3">
                                <div id="jarvisChat" style="height: 200px; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; margin-bottom: 10px;">
                                    <div class="jarvis-message mb-2">
                                        <small class="text-success">Jarvis:</small>
                                        <div class="text-white small">Hello! I'm your AI assistant. I can help you with tasks, answer questions, and monitor your productivity. Try asking me something!</div>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <input type="text" id="jarvisInput" class="form-control" placeholder="Ask Jarvis anything..." 
                                           style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;"
                                           onkeypress="if(event.key==='Enter') window.dashboard.sendToJarvis()">
                                    <button class="btn btn-success" onclick="window.dashboard.sendToJarvis()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="mt-3">
                                <h6 class="text-white mb-2">Quick Actions</h6>
                                <div class="d-flex flex-wrap gap-1">
                                    <button class="btn btn-outline-light btn-sm" onclick="window.dashboard.askJarvis('What should I focus on next?')">
                                        Focus
                                    </button>
                                    <button class="btn btn-outline-light btn-sm" onclick="window.dashboard.askJarvis('Show my productivity summary')">
                                        Summary
                                    </button>
                                    <button class="btn btn-outline-light btn-sm" onclick="window.dashboard.askJarvis('Any urgent tasks?')">
                                        Tasks
                                    </button>
                                    <button class="btn btn-outline-light btn-sm" onclick="window.dashboard.askJarvis('Help me optimize my workflow')">
                                        Optimize
                                    </button>
                                </div>
                            </div>

                            <!-- Recent Jarvis Activity -->
                            <div class="mt-3">
                                <h6 class="text-white mb-2">Recent Insights</h6>
                                <div id="jarvisInsights" class="small text-muted">
                                    <div class="mb-1">
                                        <i class="fas fa-chart-line text-success me-2"></i>
                                        Productivity peaked at 2:30 PM
                                    </div>
                                    <div class="mb-1">
                                        <i class="fas fa-brain text-info me-2"></i>
                                        Detected focus pattern on documents
                                    </div>
                                    <div>
                                        <i class="fas fa-clock text-warning me-2"></i>
                                        Suggesting break in 15 minutes
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Initialize real-time Jarvis monitoring
                        this.startJarvisMonitoring();
                    }
                } catch (error) {
                    console.error('Failed to initialize Jarvis:', error);
                }
            }

            async sendToJarvis() {
                const input = document.getElementById('jarvisInput');
                const message = input.value.trim();
                if (!message) return;

                // Add user message to chat
                this.addJarvisMessage('You', message, 'user');
                input.value = '';

                // Show typing indicator
                this.addJarvisMessage('Jarvis', 'Analyzing your request...', 'jarvis', true);

                try {
                    // Get system context for Jarvis
                    const systemContext = await this.getSystemContextForJarvis();
                    
                    // Enhanced prompt with system awareness
                    const enhancedPrompt = `
You are Jarvis, an advanced AI assistant integrated with a smart digital twin system. You have access to the user's productivity data, documents, and system capabilities.

Current System Context:
${systemContext}

User Message: "${message}"

Please respond as Jarvis would - intelligent, helpful, and capable of:
1. Referring to the user's productivity and behavioral data
2. Suggesting actions based on system capabilities
3. Creating tasks and providing guidance
4. Accessing document analysis features
5. Generating content (blogs, emails, etc.)
6. Providing insights from the smart system

Be conversational, knowledgeable about the system, and actionable in your responses.
                    `;

                    const response = await fetch('/jarvis-chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: message,
                            context: systemContext,
                            user_id: 'Paresh'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        let aiResponse = result.response || 'I understand. Let me help you with that.';
                        
                        // Remove typing indicator and add real response
                        this.removeTypingIndicator();
                        
                        // Add status indicator if not using real GPT
                        if (result.status !== 'success') {
                            aiResponse += '\n\n💡 *Note: Using backup systems*';
                        }
                        
                        // Process commands within Jarvis response
                        await this.processJarvisCommands(message, aiResponse);
                        
                        this.addJarvisMessage('Jarvis', aiResponse, 'jarvis');
                        
                        // Update Jarvis status with more detail
                        this.updateJarvisStatus(message, result.status, result.model);
                    } else {
                        throw new Error('Jarvis service unavailable');
                    }
                } catch (error) {
                    console.error('Jarvis communication error:', error);
                    this.removeTypingIndicator();
                    this.addJarvisMessage('Jarvis', "I'm experiencing a temporary connection issue with my core systems. However, I can still help you navigate the dashboard and access available features. What would you like to do?", 'jarvis');
                }
            }

            async getSystemContextForJarvis() {
                try {
                    const [stats, insights, guidance, memories] = await Promise.all([
                        fetch('/statistics').then(r => r.ok ? r.json() : null).catch(() => null),
                        fetch('/behavioral-insights/Paresh').then(r => r.ok ? r.json() : null).catch(() => null),
                        fetch('/guidance').then(r => r.ok ? r.json() : null).catch(() => null),
                        fetch('/memories?limit=3').then(r => r.ok ? r.json() : null).catch(() => null)
                    ]);

                    let context = '';
                    
                    if (insights) {
                        context += `Productivity Score: ${insights.productivity_score}%, Focus Sessions: ${insights.focus_sessions}, `;
                        if (insights.suggestions) {
                            context += `Recent Suggestions: ${insights.suggestions.slice(0, 2).join(', ')}. `;
                        }
                    }
                    
                    if (stats && stats.overview) {
                        context += `Total Memories: ${stats.overview.total_memories}, Success Rate: ${stats.overview.success_rate}%. `;
                    }
                    
                    if (memories && memories.length > 0) {
                        context += `Recent Documents: ${memories.map(m => m.metadata?.filename || 'document').join(', ')}. `;
                    }
                    
                    context += `Available Features: Document Analysis, Smart Questions, Email Drafting, Meeting Processing, Blog Generation. `;
                    context += `Current Time: ${new Date().toLocaleString()}. `;

                    return context || 'System context loading...';
                } catch (error) {
                    return 'Limited system context available.';
                }
            }

            async processJarvisCommands(userMessage, jarvisResponse) {
                const message = userMessage.toLowerCase();
                const response = jarvisResponse.toLowerCase();
                
                // Enhanced command processing with AI response analysis
                
                // 1. Task Management Commands
                if (message.includes('create task') || message.includes('add task') || response.includes('create a task') || response.includes('add to your tasks')) {
                    const taskMatch = userMessage.match(/create task[:\s]+"?([^"]+)"?/i) || 
                                    userMessage.match(/add task[:\s]+"?([^"]+)"?/i) ||
                                    jarvisResponse.match(/Task: "?([^"]+)"?/i);
                    if (taskMatch) {
                        await this.createSmartTaskFromJarvis(taskMatch[1], userMessage);
                    }
                }
                
                // 2. Navigation and Interface Commands
                if (message.includes('open document') || message.includes('show document') || message.includes('workspace')) {
                    this.switchTab('workspace');
                    this.showNotification('📄 Opened workspace view');
                }
                
                if (message.includes('analyze') || message.includes('analysis') || response.includes('analyze') || response.includes('analysis')) {
                    this.switchTab('analysis');
                    this.showNotification('🔍 Opened analysis view');
                }
                
                if (message.includes('collaboration') || message.includes('slack') || message.includes('teams') || response.includes('collaboration')) {
                    this.activateTool('collaboration');
                    this.showNotification('👥 Opened collaboration intelligence');
                }
                
                // 3. Content Generation Commands
                if (message.includes('generate blog') || message.includes('write blog') || message.includes('create post') || response.includes('blog post')) {
                    this.switchTab('blog');
                    this.showNotification('✍️ Opened blog generation');
                }
                
                if (message.includes('email') && (message.includes('draft') || message.includes('write')) || response.includes('draft email')) {
                    this.switchTab('email');
                    this.showNotification('📧 Opened email drafting');
                }
                
                // 4. Data and Analytics Commands
                if (message.includes('productivity') || message.includes('stats') || message.includes('summary') || message.includes('insights')) {
                    await this.loadRealBehavioralData();
                    await this.loadRealInsights();
                    this.showNotification('📊 Refreshed productivity insights');
                }
                
                if (message.includes('memory') || message.includes('remember') || message.includes('recall')) {
                    this.activateTool('memory');
                    this.showNotification('🧠 Accessed memory system');
                }
                
                if (message.includes('analytics') || message.includes('charts') || message.includes('data')) {
                    this.activateTool('analytics');
                    this.showNotification('📈 Opened analytics dashboard');
                }
                
                // 5. Voice and Recording Commands
                if (message.includes('voice') || message.includes('record') || message.includes('microphone')) {
                    const voiceBtn = document.getElementById('voiceBtn');
                    if (voiceBtn) {
                        voiceBtn.click();
                        this.showNotification('🎤 Voice interface activated');
                    }
                }
                
                // 6. Smart Suggestions from AI Response
                if (response.includes('i recommend') || response.includes('you should') || response.includes('suggest')) {
                    await this.extractAndShowSmartSuggestions(jarvisResponse);
                }
                
                // 7. System Status Commands
                if (message.includes('status') || message.includes('health') || message.includes('system')) {
                    await this.showSystemStatus();
                }
            }

            createTaskFromJarvis(taskDescription) {
                // Add task to a visual task list in Jarvis
                const tasksContainer = document.getElementById('jarvisInsights');
                if (tasksContainer) {
                    const taskHtml = `
                        <div class="mb-1 jarvis-task" style="background: rgba(40, 167, 69, 0.2); padding: 5px; border-radius: 5px;">
                            <i class="fas fa-tasks text-success me-2"></i>
                            <small>${taskDescription}</small>
                            <button class="btn btn-outline-light btn-sm ms-2" style="font-size: 10px; padding: 2px 5px;" onclick="this.parentElement.remove()">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    `;
                    tasksContainer.insertAdjacentHTML('afterbegin', taskHtml);
                }
                
                this.showNotification(`✅ Task created: ${taskDescription}`);
            }

            async createSmartTaskFromJarvis(taskDescription, originalMessage) {
                // Enhanced task creation with priority detection and categorization
                const priority = this.detectTaskPriority(originalMessage);
                const category = this.detectTaskCategory(taskDescription);
                const dueDate = this.extractDueDate(originalMessage);
                
                // Add task to visual task list with enhanced metadata
                const tasksContainer = document.getElementById('jarvisInsights');
                if (tasksContainer) {
                    const taskId = `task_${Date.now()}`;
                    const priorityColor = priority === 'high' ? 'danger' : priority === 'medium' ? 'warning' : 'info';
                    const categoryIcon = this.getCategoryIcon(category);
                    
                    const taskHtml = `
                        <div class="mb-2 jarvis-task border-start border-3 border-${priorityColor}" style="background: rgba(40, 167, 69, 0.1); padding: 8px; border-radius: 8px;" data-task-id="${taskId}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="fas ${categoryIcon} text-${priorityColor} me-2"></i>
                                        <small class="text-white fw-bold">${taskDescription}</small>
                                    </div>
                                    <div class="d-flex gap-1">
                                        <span class="badge bg-${priorityColor} badge-sm">${priority}</span>
                                        <span class="badge bg-secondary badge-sm">${category}</span>
                                        ${dueDate ? `<span class="badge bg-info badge-sm">${dueDate}</span>` : ''}
                                    </div>
                                </div>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-outline-success btn-sm" style="font-size: 10px; padding: 2px 5px;" onclick="window.dashboard.completeJarvisTask('${taskId}')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" style="font-size: 10px; padding: 2px 5px;" onclick="window.dashboard.removeJarvisTask('${taskId}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    tasksContainer.insertAdjacentHTML('afterbegin', taskHtml);
                }
                
                this.showNotification(`✅ Smart task created: ${taskDescription} (${priority} priority)`);
            }

            detectTaskPriority(message) {
                const urgent = ['urgent', 'asap', 'immediately', 'critical', 'emergency'];
                const high = ['important', 'priority', 'soon', 'deadline', 'must'];
                const medium = ['should', 'need to', 'when possible'];
                
                const msg = message.toLowerCase();
                if (urgent.some(word => msg.includes(word))) return 'high';
                if (high.some(word => msg.includes(word))) return 'medium';
                if (medium.some(word => msg.includes(word))) return 'medium';
                return 'low';
            }

            detectTaskCategory(description) {
                const categories = {
                    'meeting': ['meeting', 'call', 'discussion', 'interview'],
                    'document': ['document', 'file', 'report', 'write', 'draft'],
                    'email': ['email', 'message', 'contact', 'reply'],
                    'analysis': ['analyze', 'review', 'research', 'study'],
                    'development': ['code', 'develop', 'build', 'implement'],
                    'planning': ['plan', 'strategy', 'organize', 'schedule']
                };
                
                const desc = description.toLowerCase();
                for (const [category, keywords] of Object.entries(categories)) {
                    if (keywords.some(keyword => desc.includes(keyword))) {
                        return category;
                    }
                }
                return 'general';
            }

            getCategoryIcon(category) {
                const icons = {
                    'meeting': 'fa-users',
                    'document': 'fa-file-alt',
                    'email': 'fa-envelope',
                    'analysis': 'fa-search',
                    'development': 'fa-code',
                    'planning': 'fa-calendar',
                    'general': 'fa-tasks'
                };
                return icons[category] || 'fa-tasks';
            }

            extractDueDate(message) {
                const datePatterns = [
                    /today/i, /tomorrow/i, /this week/i, /next week/i,
                    /monday|tuesday|wednesday|thursday|friday|saturday|sunday/i,
                    /\d{1,2}\/\d{1,2}/,
                    /by (\w+)/i
                ];
                
                for (const pattern of datePatterns) {
                    const match = message.match(pattern);
                    if (match) {
                        return match[0];
                    }
                }
                return null;
            }

            async extractAndShowSmartSuggestions(aiResponse) {
                // Extract actionable suggestions from AI response
                const suggestions = aiResponse.match(/(?:i recommend|you should|suggest)(.*?)(?:\.|$)/gi);
                if (suggestions && suggestions.length > 0) {
                    const container = document.getElementById('jarvisInsights');
                    if (container) {
                        const suggestionHtml = `
                            <div class="mb-2 p-2" style="background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 3px solid #667eea;">
                                <small class="text-info">💡 AI Suggestions:</small>
                                <ul class="small mb-0 ps-3 text-white">
                                    ${suggestions.map(s => `<li>${s.replace(/^(i recommend|you should|suggest)\s*/i, '').trim()}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                        container.insertAdjacentHTML('afterbegin', suggestionHtml);
                    }
                }
            }

            async showSystemStatus() {
                // Display comprehensive system status
                const status = {
                    jarvis: 'Connected',
                    collaboration: await this.checkCollaborationStatus(),
                    documents: await this.checkDocumentSystemStatus(),
                    memory: await this.checkMemoryStatus(),
                    analytics: 'Active'
                };
                
                const statusHtml = Object.entries(status).map(([system, state]) => 
                    `<div class="d-flex justify-content-between mb-1">
                        <span>${system.charAt(0).toUpperCase() + system.slice(1)}:</span>
                        <span class="text-${state.includes('Connected') || state.includes('Active') ? 'success' : 'warning'}">${state}</span>
                    </div>`
                ).join('');
                
                const container = document.getElementById('jarvisInsights');
                if (container) {
                    container.insertAdjacentHTML('afterbegin', `
                        <div class="mb-2 p-2" style="background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                            <small class="text-info">🔧 System Status:</small>
                            <div class="small mt-2">${statusHtml}</div>
                        </div>
                    `);
                }
            }

            async checkCollaborationStatus() {
                try {
                    const response = await fetch('http://localhost:8001/health');
                    return response.ok ? 'Connected' : 'Offline';
                } catch {
                    return 'Offline';
                }
            }

            async checkDocumentSystemStatus() {
                try {
                    const response = await fetch('/documents');
                    return response.ok ? 'Active' : 'Limited';
                } catch {
                    return 'Limited';
                }
            }

            async checkMemoryStatus() {
                try {
                    const response = await fetch('/memories');
                    return response.ok ? 'Active' : 'Limited';
                } catch {
                    return 'Limited';
                }
            }

            completeJarvisTask(taskId) {
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    taskElement.classList.add('completed');
                    taskElement.style.opacity = '0.6';
                    taskElement.querySelector('.fa-check').classList.add('text-success');
                    setTimeout(() => taskElement.remove(), 2000);
                    this.showNotification('✅ Task completed');
                }
            }

            removeJarvisTask(taskId) {
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    taskElement.remove();
                    this.showNotification('🗑️ Task removed');
                }
            }

            updateJarvisStatus(lastMessage, status = 'success', model = null) {
                // Update Jarvis current task based on conversation
                if (lastMessage.includes('productivity') || lastMessage.includes('analyze')) {
                    this.jarvis.currentTask = 'Analyzing your productivity patterns';
                } else if (lastMessage.includes('document') || lastMessage.includes('file')) {
                    this.jarvis.currentTask = 'Reviewing your documents';
                } else if (lastMessage.includes('task') || lastMessage.includes('todo')) {
                    this.jarvis.currentTask = 'Managing your tasks';
                } else if (lastMessage.includes('blog') || lastMessage.includes('post')) {
                    this.jarvis.currentTask = 'Assisting with content creation';
                } else {
                    this.jarvis.currentTask = 'Monitoring your productivity';
                }
                
                // Add status indicator based on GPT connection
                if (status === 'success' && model) {
                    this.jarvis.currentTask += ` (${model})`;
                } else if (status === 'fallback') {
                    this.jarvis.currentTask += ' (Backup Mode)';
                } else if (status === 'error') {
                    this.jarvis.currentTask += ' (Limited Mode)';
                }
                
                // Update UI
                const statusElement = document.querySelector('.collaboration-hub .collab-item small');
                if (statusElement) {
                    statusElement.textContent = this.jarvis.currentTask;
                }
            }

            askJarvis(question) {
                document.getElementById('jarvisInput').value = question;
                this.sendToJarvis();
            }

            addJarvisMessage(sender, message, type, isTyping = false) {
                const chatContainer = document.getElementById('jarvisChat');
                const messageDiv = document.createElement('div');
                messageDiv.className = `jarvis-message mb-2 ${isTyping ? 'typing' : ''}`;
                
                const senderClass = type === 'user' ? 'text-info' : 'text-success';
                messageDiv.innerHTML = `
                    <small class="${senderClass}">${sender}:</small>
                    <div class="text-white small">${message}</div>
                `;
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            removeTypingIndicator() {
                const typingIndicator = document.querySelector('.jarvis-message.typing');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            startJarvisMonitoring() {
                // Update Jarvis insights every 30 seconds
                setInterval(async () => {
                    try {
                        const [insights, guidance] = await Promise.all([
                            fetch('/insights').then(r => r.ok ? r.json() : null).catch(() => null),
                            fetch('/guidance').then(r => r.ok ? r.json() : null).catch(() => null)
                        ]);

                        const insightsContainer = document.getElementById('jarvisInsights');
                        if (insightsContainer && (insights || guidance)) {
                            let insightsHtml = '';
                            
                            if (insights && insights.recent_insights) {
                                insights.recent_insights.slice(0, 3).forEach(insight => {
                                    insightsHtml += `
                                        <div class="mb-1">
                                            <i class="fas fa-lightbulb text-warning me-2"></i>
                                            ${insight}
                                        </div>
                                    `;
                                });
                            }
                            
                            if (guidance && guidance.suggestions) {
                                guidance.suggestions.slice(0, 2).forEach(suggestion => {
                                    insightsHtml += `
                                        <div class="mb-1">
                                            <i class="fas fa-compass text-info me-2"></i>
                                            ${suggestion}
                                        </div>
                                    `;
                                });
                            }
                            
                            if (insightsHtml) {
                                insightsContainer.innerHTML = insightsHtml;
                            }
                        }
                    } catch (error) {
                        console.warn('Jarvis monitoring update failed:', error);
                    }
                }, 30000);
            }

            async loadRealInsights() {
                try {
                    // Get real AI insights from multiple sources
                    const [behavioralData, aiCoaching, proactiveInsights, guidance] = await Promise.all([
                        fetch('/behavioral-insights/Paresh').then(r => r.ok ? r.json() : null).catch(() => null),
                        fetch('/ai-productivity-coaching/Paresh').then(r => r.ok ? r.json() : null).catch(() => null),
                        fetch('/proactive-suggestions/Paresh').then(r => r.ok ? r.json() : null).catch(() => null),
                        fetch('/guidance').then(r => r.ok ? r.json() : null).catch(() => null)
                    ]);

                    const container = document.querySelector('.ai-insights .glass-card');
                    if (!container) return;

                    let insightsHtml = `
                        <h5 class="text-white mb-4">
                            <i class="fas fa-robot me-2 text-success"></i>
                            AI Intelligence
                        </h5>
                    `;

                    // Real behavioral insights
                    if (behavioralData && behavioralData.productivity_score !== undefined) {
                        const urgentClass = behavioralData.productivity_score < 60 ? 'urgent-highlight' : 'context-highlight';
                        insightsHtml += `
                            <div class="insight-card ${urgentClass}">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-chart-trending-up text-warning me-3"></i>
                                    <h6 class="mb-0">Productivity Analysis</h6>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <div class="progress" style="height: 8px; width: 100%;">
                                        <div class="progress-bar bg-${behavioralData.productivity_score >= 70 ? 'success' : behavioralData.productivity_score >= 50 ? 'warning' : 'danger'}" 
                                             style="width: ${behavioralData.productivity_score}%"></div>
                                    </div>
                                    <span class="ms-2 small">${behavioralData.productivity_score}%</span>
                                </div>
                                <p class="small mb-0">Based on ${behavioralData.focus_sessions || 0} focus sessions and real behavioral tracking.</p>
                            </div>
                        `;
                    }

                    // Real AI coaching insights
                    if (aiCoaching && aiCoaching.coaching_insights) {
                        aiCoaching.coaching_insights.slice(0, 2).forEach(insight => {
                            insightsHtml += `
                                <div class="insight-card">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-brain text-success me-3"></i>
                                        <h6 class="mb-0">${insight.category || 'AI Coaching'}</h6>
                                    </div>
                                    <p class="small mb-0">${insight.insight || insight.message}</p>
                                    <div class="small text-muted mt-1">Confidence: ${((insight.confidence || 0.8) * 100).toFixed(0)}%</div>
                                </div>
                            `;
                        });
                    }

                    // Proactive suggestions
                    if (proactiveInsights && proactiveInsights.suggestions && proactiveInsights.suggestions.length > 0) {
                        insightsHtml += `
                            <div class="insight-card">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-lightbulb text-info me-3"></i>
                                    <h6 class="mb-0">Smart Recommendations</h6>
                                </div>
                                <ul class="small mb-0 ps-3">
                                    ${proactiveInsights.suggestions.slice(0, 3).map(suggestion => 
                                        `<li>${suggestion.suggestion || suggestion}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    // Real behavioral suggestions
                    if (behavioralData && behavioralData.suggestions && behavioralData.suggestions.length > 0) {
                        insightsHtml += `
                            <div class="insight-card">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-compass text-info me-3"></i>
                                    <h6 class="mb-0">Behavioral Insights</h6>
                                </div>
                                <ul class="small mb-0 ps-3">
                                    ${behavioralData.suggestions.slice(0, 2).map(suggestion => 
                                        `<li>${suggestion}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    // System guidance
                    if (guidance && guidance.suggestions) {
                        insightsHtml += `
                            <div class="insight-card">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-route text-warning me-3"></i>
                                    <h6 class="mb-0">System Guidance</h6>
                                </div>
                                <ul class="small mb-0 ps-3">
                                    ${guidance.suggestions.slice(0, 2).map(suggestion => 
                                        `<li>${suggestion}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    // If no real insights available, show loading
                    if (!behavioralData && !aiCoaching && !proactiveInsights && !guidance) {
                        insightsHtml += `
                            <div class="insight-card">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-sync fa-spin text-info me-3"></i>
                                    <h6 class="mb-0">Loading Intelligence</h6>
                                </div>
                                <p class="small mb-0">Connecting to AI services... Your insights will appear here.</p>
                                <button class="btn btn-outline-light btn-sm mt-2" onclick="window.dashboard.loadRealInsights()">
                                    <i class="fas fa-sync me-1"></i>Refresh
                                </button>
                            </div>
                        `;
                    }

                    container.innerHTML = insightsHtml;
                } catch (error) {
                    console.error('Failed to load real AI insights:', error);
                    this.showNotification('⚠️ AI insights temporarily unavailable');
                }
            }

            async loadRealActivity() {
                try {
                    const activityResponse = await fetch('/recent-activity');
                    if (activityResponse.ok) {
                        const activities = await activityResponse.json();
                        return activities.slice(0, 3).map(activity => `
                            <div class="mb-2">
                                <i class="fas fa-${this.getActivityIcon(activity.type)} text-${this.getActivityColor(activity.type)} me-2"></i>
                                ${activity.description}
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.warn('Recent activity not available:', error);
                }
                
                return '<div class="small text-muted">No recent activity to display</div>';
            }

            getActivityIcon(type) {
                const icons = {
                    'upload': 'file-upload',
                    'voice': 'microphone',
                    'collaboration': 'users',
                    'analysis': 'chart-line',
                    'default': 'circle'
                };
                return icons[type] || icons.default;
            }

            getActivityColor(type) {
                const colors = {
                    'upload': 'success',
                    'voice': 'warning',
                    'collaboration': 'info',
                    'analysis': 'primary',
                    'default': 'muted'
                };
                return colors[type] || colors.default;
            }

            getFileIcon(filename) {
                if (!filename) return 'file';
                const ext = filename.split('.').pop().toLowerCase();
                const icons = {
                    'pdf': 'file-pdf',
                    'doc': 'file-word',
                    'docx': 'file-word',
                    'txt': 'file-alt',
                    'xls': 'file-excel',
                    'xlsx': 'file-excel',
                    'ppt': 'file-powerpoint',
                    'pptx': 'file-powerpoint',
                    'jpg': 'file-image',
                    'jpeg': 'file-image',
                    'png': 'file-image',
                    'gif': 'file-image'
                };
                return icons[ext] || 'file';
            }

            async monitorTask(taskId, filename) {
                console.log(`📡 Starting task monitoring for ${taskId} (${filename})`);
                this.addProgressItem(`Monitoring task: ${filename}`, 'processing');
                
                let attemptCount = 0;
                const maxAttempts = 150; // 5 minutes with 2-second intervals
                
                const checkInterval = setInterval(async () => {
                    attemptCount++;
                    
                    try {
                        const response = await fetch(`/task/${taskId}`);
                        if (response.ok) {
                            const task = await response.json();
                            console.log(`📊 Task ${taskId} status:`, task.status, `progress: ${task.progress}%`);
                            
                            // Update progress in UI
                            const progressBar = document.querySelector(`[data-task-id="${taskId}"] .progress-bar`);
                            if (progressBar) {
                                progressBar.style.width = `${task.progress || 50}%`;
                            }
                            
                            if (task.status === 'completed') {
                                clearInterval(checkInterval);
                                console.log(`✅ Task ${taskId} completed with full task object:`, task);
                                console.log('Task result:', task.result);
                                console.log('Task result type:', typeof task.result);
                                console.log('Task result length:', task.result ? (typeof task.result === 'string' ? task.result.length : 'Not a string') : 'No result');
                                
                                if (task.result && typeof task.result === 'object') {
                                    console.log('Result object keys:', Object.keys(task.result));
                                    console.log('Result object values preview:', Object.entries(task.result).map(([k,v]) => [k, typeof v === 'string' ? `${v.substring(0,100)}...` : v]));
                                }
                                
                                this.addNotification(`${filename} analysis complete`, 'success', 'Analysis Complete');
                                this.updateProgressItemStatus(`monitoring-${taskId}`, 'completed');
                                
                                // Ensure we have a result to display
                                if (task.result) {
                                    this.displayTaskResult(taskId, task.result, filename);
                                } else {
                                    console.warn('Task completed but no result data found');
                                    this.addNotification(`${filename} completed but no results found`, 'warning', 'Analysis Warning');
                                }
                                
                                this.loadRealDocuments();
                                this.loadRealInsights();
                                
                            } else if (task.status === 'failed' || task.status === 'error') {
                                clearInterval(checkInterval);
                                console.log(`❌ Task ${taskId} failed:`, task.error_message);
                                
                                this.addNotification(`${filename} analysis failed: ${task.error_message || 'Unknown error'}`, 'error', 'Analysis Failed');
                                this.updateProgressItemStatus(`monitoring-${taskId}`, 'error');
                                
                            } else if (task.status === 'processing') {
                                // Task is still processing, continue monitoring
                                console.log(`⏳ Task ${taskId} still processing... (${task.progress || 0}%)`);
                            }
                            
                        } else {
                            console.warn(`Failed to fetch task ${taskId}:`, response.status);
                            if (response.status === 404) {
                                // Task not found, might be completed and cleaned up
                                clearInterval(checkInterval);
                                this.addNotification(`Task ${filename} may have completed - check results`, 'info', 'Task Status');
                            }
                        }
                    } catch (error) {
                        console.warn('Task monitoring error:', error);
                        if (attemptCount > 10) {
                            // After 20 seconds of errors, notify user
                            this.addNotification(`Monitoring ${filename} - connection issues`, 'warning', 'Connection');
                        }
                    }
                    
                    // Stop monitoring after max attempts
                    if (attemptCount >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.log(`⏰ Task monitoring timeout for ${taskId}`);
                        this.addNotification(`Monitoring timeout for ${filename} - task may still be running`, 'warning', 'Timeout');
                    }
                }, 2000);
                
                // Store interval reference for potential cleanup
                this.taskIntervals = this.taskIntervals || new Map();
                this.taskIntervals.set(taskId, checkInterval);
            }

            displayTaskResult(taskId, result, filename) {
                // Update the main work area with results
                const workArea = document.querySelector('#activeWorkArea');
                if (workArea && result) {
                    
                    console.log('🔍 Full result object received:', result);
                    console.log('🔍 Result type:', typeof result);
                    console.log('🔍 Result keys:', result ? Object.keys(result) : 'No keys');
                    
                    // Process the result object to extract meaningful content
                    let displayContent = '';
                    let resultSummary = '';
                    let fullResultObject = result;
                    
                    if (typeof result === 'object') {
                        // Check for common result properties - prioritize comprehensive content
                        if (result.analysis && result.analysis.length > 100) {
                            displayContent = result.analysis;
                            resultSummary = 'Document Analysis';
                        } else if (result.result && result.result.length > 100) {
                            displayContent = result.result;
                            resultSummary = 'Analysis Result';
                        } else if (result.summary && result.summary.length > 100) {
                            displayContent = result.summary;
                            resultSummary = 'Document Summary';
                        } else if (result.content && result.content.length > 100) {
                            displayContent = result.content;
                            resultSummary = 'Processed Content';
                        } else if (result.insights && result.insights.length > 100) {
                            displayContent = result.insights;
                            resultSummary = 'Document Insights';
                        } else if (result.text && result.text.length > 100) {
                            displayContent = result.text;
                            resultSummary = 'Extracted Text';
                        } else {
                            // Check for nested objects that might contain the full analysis
                            for (const [key, value] of Object.entries(result)) {
                                if (typeof value === 'string' && value.length > 200) {
                                    displayContent = value;
                                    resultSummary = `${key.charAt(0).toUpperCase() + key.slice(1)} Analysis`;
                                    break;
                                }
                            }
                            
                            // If still no good content found, format the entire object
                            if (!displayContent) {
                                displayContent = this.formatObjectAsHTML(result);
                                resultSummary = 'Analysis Results';
                            }
                        }
                    } else if (typeof result === 'string') {
                        displayContent = result;
                        resultSummary = 'Analysis Result';
                    } else {
                        displayContent = String(result);
                        resultSummary = 'Analysis Result';
                    }
                    
                    // Log what we're about to display
                    console.log('📝 Content to display (length):', displayContent.length);
                    console.log('📝 Content preview:', displayContent.substring(0, 200) + '...');
                    
                    workArea.innerHTML = `
                        <div class="result-display">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle me-3" style="font-size: 2rem; color: var(--success-color);"></i>
                                    <div>
                                        <h4 style="color: var(--text-primary); margin: 0;">Analysis Complete</h4>
                                        <p style="color: var(--text-secondary); margin: 0;">${filename} • ${resultSummary}</p>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="window.dashboard.downloadResult('${taskId}')">
                                        <i class="fas fa-download me-1"></i>Download
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="window.dashboard.shareResult('${taskId}')">
                                        <i class="fas fa-share me-1"></i>Share
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="window.dashboard.clearWorkspace()">
                                        <i class="fas fa-times me-1"></i>Close
                                    </button>
                                </div>
                            </div>
                            <div class="result-content" style="background: var(--surface-bg); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); max-height: 600px; overflow-y: auto;">
                                <div style="color: var(--text-primary); line-height: 1.7; white-space: pre-wrap; font-size: 15px;">${displayContent}</div>
                                ${displayContent.length < 200 ? `
                                    <details style="margin-top: 20px; padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <summary style="color: var(--primary-blue); cursor: pointer; font-weight: 500;">📋 View Raw Result Object</summary>
                                        <pre style="margin-top: 12px; color: var(--text-secondary); font-size: 12px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word;">${JSON.stringify(fullResultObject, null, 2)}</pre>
                                    </details>
                                ` : ''}
                            </div>
                            <div class="result-metadata mt-3" style="background: var(--card-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);">
                                <small style="color: var(--text-muted);">Task ID: ${taskId} • Completed: ${new Date().toLocaleString()}</small>
                            </div>
                        </div>
                    `;
                    
                    // Save to results history with the properly formatted content
                    this.addToResultsHistory('analysis', `Analysis: ${filename}`, displayContent);
                }
                
                console.log(`✅ Result displayed for task ${taskId}:`, result);
            }
            
            // Helper method to format objects as readable HTML
            formatObjectAsHTML(obj) {
                if (!obj || typeof obj !== 'object') {
                    return String(obj);
                }
                
                let html = '';
                
                // Handle arrays
                if (Array.isArray(obj)) {
                    html += '<ul style="margin: 0; padding-left: 20px; line-height: 1.6;">';
                    obj.forEach(item => {
                        html += `<li style="margin-bottom: 12px;">${this.formatObjectAsHTML(item)}</li>`;
                    });
                    html += '</ul>';
                    return html;
                }
                
                // Handle objects - look for meaningful analysis content first
                const meaningfulKeys = ['analysis', 'summary', 'insights', 'result', 'content', 'key_points', 'recommendations', 'findings'];
                const otherKeys = Object.keys(obj).filter(key => !meaningfulKeys.includes(key.toLowerCase()));
                const sortedKeys = [...meaningfulKeys.filter(key => obj[key]), ...otherKeys];
                
                for (const key of sortedKeys) {
                    const value = obj[key];
                    if (!value) continue;
                    
                    const formattedKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                    
                    if (typeof value === 'string' && value.length > 100) {
                        // Long text content - display prominently
                        html += `
                            <div style="margin-bottom: 24px;">
                                <h4 style="color: var(--primary-blue); margin-bottom: 12px; font-size: 18px;">${formattedKey}</h4>
                                <div style="background: var(--card-bg); padding: 16px; border-radius: 8px; border-left: 3px solid var(--primary-blue); line-height: 1.7; white-space: pre-wrap;">${value}</div>
                            </div>
                        `;
                    } else if (typeof value === 'object' && value !== null) {
                        html += `
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: var(--primary-blue); margin-bottom: 10px; font-size: 16px;">${formattedKey}</h5>
                                <div style="margin-left: 16px; padding: 12px; background: var(--surface-bg); border-radius: 6px;">${this.formatObjectAsHTML(value)}</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="margin-bottom: 12px; display: flex; align-items: flex-start;">
                                <strong style="color: var(--primary-blue); min-width: 120px; margin-right: 12px;">${formattedKey}:</strong>
                                <span style="flex: 1; line-height: 1.5;">${String(value)}</span>
                            </div>
                        `;
                    }
                }
                
                return html;
            }

            async openDocument(docId) {
                try {
                    const response = await fetch(`/memory/${docId}`);
                    if (response.ok) {
                        const doc = await response.json();
                        
                        const docArea = document.querySelector('#activeDocument');
                        if (docArea) {
                            docArea.innerHTML = `
                                <div class="mb-3">
                                    <h6 class="text-info">📄 Document View</h6>
                                    <div class="p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                                        <h6 class="text-white mb-2">${doc.metadata?.filename || 'Document'}</h6>
                                        <div class="text-white mb-3">${doc.content || 'No content available'}</div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-light btn-sm" onclick="window.dashboard.reprocessDocument('${docId}')">
                                                <i class="fas fa-sync me-1"></i>Reprocess
                                            </button>
                                            <button class="btn btn-outline-light btn-sm" onclick="window.dashboard.analyzeDocument('${docId}')">
                                                <i class="fas fa-search me-1"></i>Analyze
                                            </button>
                                        </div>
                                        <small class="text-muted d-block mt-2">Memory ID: ${docId}</small>
                                    </div>
                                </div>
                            `;
                        }
                        
                        this.addNotification('Document opened successfully', 'success', 'Document Access');
                    }
                } catch (error) {
                    console.error('Failed to open document:', error);
                    this.addNotification('Failed to open document', 'error', 'Document Error');
                }
            }

            async reprocessDocument(docId) {
                try {
                    const response = await fetch(`/memory/${docId}/reprocess`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'document_analysis' })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.addNotification('Document reprocessing started', 'info', 'Document Processing');
                        this.addProgressItem('Document reprocessing in progress', 'processing');
                        this.monitorTask(result.task_id, 'Reprocessed Document');
                    }
                } catch (error) {
                    console.error('Reprocess error:', error);
                    this.addNotification('Document reprocessing failed', 'error', 'Processing Error');
                }
            }

            switchTab(tabName) {
                // Update active tab
                document.querySelectorAll('.doc-tab').forEach(tab => tab.classList.remove('active'));
                event.target.closest('.doc-tab').classList.add('active');
                
                // Switch content based on tab
                const content = document.getElementById('activeDocument');
                if (!content) return;

                switch(tabName) {
                    case 'workspace':
                        this.loadRealDocuments();
                        break;
                    case 'analysis':
                        this.showAnalysisTab(content);
                        break;
                    case 'questions':
                        this.showQuestionsTab(content);
                        break;
                    case 'email':
                        this.showEmailTab(content);
                        break;
                    case 'meeting':
                        this.showMeetingTab(content);
                        break;
                    case 'blog':
                        this.showBlogTab(content);
                        break;
                }
            }

            showAnalysisTab(content) {
                content.innerHTML = `
                    <div class="mb-3">
                        <h6 class="text-info">📊 Comprehensive Document Analysis</h6>
                        <div class="p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div class="mb-3">
                                <label class="form-label text-dark fw-bold">Select Document or Upload New:</label>
                                <div class="d-flex gap-2 mb-3">
                                    <select class="form-select" id="docSelectAnalysis" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                        <option value="">Choose document...</option>
                                    </select>
                                    <input type="file" id="uploadAnalysis" class="form-control" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);" accept=".pdf,.docx,.txt">
                                </div>
                                <button class="btn btn-success" onclick="window.dashboard.runDocumentAnalysis()">
                                    <i class="fas fa-search me-2"></i>Run Comprehensive Analysis
                                </button>
                            </div>
                            <div id="analysisResults" class="mt-3"></div>
                        </div>
                    </div>
                `;
                
                // Load available documents into select
                this.populateDocumentSelect('docSelectAnalysis');
                
                // Setup file upload
                document.getElementById('uploadAnalysis').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        this.uploadForAnalysis(e.target.files[0], 'document_analysis');
                    }
                });
            }

            showQuestionsTab(content) {
                content.innerHTML = `
                    <div class="mb-3">
                        <h6 class="text-info">❓ Smart Questions Generator</h6>
                        <div class="p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div class="mb-3">
                                <label class="form-label text-dark fw-bold">Select Document or Upload New:</label>
                                <div class="d-flex gap-2 mb-3">
                                    <select class="form-select" id="docSelectQuestions" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                        <option value="">Choose document...</option>
                                    </select>
                                    <input type="file" id="uploadQuestions" class="form-control" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);" accept=".pdf,.docx,.txt">
                                </div>
                                <button class="btn btn-primary" onclick="window.dashboard.generateSmartQuestions()">
                                    <i class="fas fa-question-circle me-2"></i>Generate Smart Questions
                                </button>
                            </div>
                            <div id="questionsResults" class="mt-3"></div>
                        </div>
                    </div>
                `;
                
                this.populateDocumentSelect('docSelectQuestions');
                
                document.getElementById('uploadQuestions').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        this.uploadForAnalysis(e.target.files[0], 'smart_questions');
                    }
                });
            }

            showEmailTab(content) {
                content.innerHTML = `
                    <div class="mb-3">
                        <h6 class="text-info">📧 Email Drafting Assistant</h6>
                        <div class="p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div class="mb-3">
                                <label class="form-label text-dark fw-bold">Select Document or Upload New:</label>
                                <div class="d-flex gap-2 mb-3">
                                    <select class="form-select" id="docSelectEmail" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                        <option value="">Choose document...</option>
                                    </select>
                                    <input type="file" id="uploadEmail" class="form-control" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);" accept=".pdf,.docx,.txt">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-dark fw-bold">Email Context:</label>
                                    <textarea class="form-control" id="emailContext" rows="3" placeholder="Describe the purpose of the email..." style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);"></textarea>
                                </div>
                                <button class="btn btn-warning" onclick="window.dashboard.generateEmailDraft()">
                                    <i class="fas fa-envelope me-2"></i>Generate Email Draft
                                </button>
                            </div>
                            <div id="emailResults" class="mt-3"></div>
                        </div>
                    </div>
                `;
                
                this.populateDocumentSelect('docSelectEmail');
                
                document.getElementById('uploadEmail').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        this.uploadForAnalysis(e.target.files[0], 'email_drafting');
                    }
                });
            }

            showMeetingTab(content) {
                content.innerHTML = `
                    <div class="mb-3">
                        <h6 class="text-info">🎤 Meeting Transcript Processor</h6>
                        <div class="p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div class="mb-3">
                                <label class="form-label text-dark fw-bold">Upload Meeting Transcript or Record Live:</label>
                                <div class="d-flex gap-2 mb-3">
                                    <input type="file" id="uploadMeeting" class="form-control" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);" accept=".pdf,.docx,.txt">
                                    <button class="btn btn-success" onclick="window.dashboard.startLiveRecording()">
                                        <i class="fas fa-microphone me-2"></i>Live Record
                                    </button>
                                </div>
                                <button class="btn btn-info" onclick="window.dashboard.processMeetingTranscript()">
                                    <i class="fas fa-cogs me-2"></i>Process Meeting
                                </button>
                            </div>
                            <div id="meetingResults" class="mt-3"></div>
                        </div>
                    </div>
                `;
                
                document.getElementById('uploadMeeting').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        this.uploadForAnalysis(e.target.files[0], 'meeting_processing');
                    }
                });
            }

            showBlogTab(content) {
                content.innerHTML = `
                    <div class="mb-3">
                        <h6 class="text-info">✍️ Blog/LinkedIn Post Generator</h6>
                        <div class="p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div class="mb-3">
                                <label class="form-label text-dark fw-bold">Post Title/Topic:</label>
                                <input type="text" class="form-control" id="blogTitle" placeholder="Enter your blog post title or topic..." style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-dark fw-bold">Post Type:</label>
                                <select class="form-select" id="postType" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                    <option value="blog">Blog Post</option>
                                    <option value="linkedin">LinkedIn Post</option>
                                    <option value="twitter">Twitter Thread</option>
                                    <option value="article">Technical Article</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-dark fw-bold">Additional Context (Optional):</label>
                                <textarea class="form-control" id="blogContext" rows="3" placeholder="Any specific points, audience, or style you want..." style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);"></textarea>
                            </div>
                            <button class="btn btn-success" onclick="window.dashboard.generateBlogPost()">
                                <i class="fas fa-edit me-2"></i>Generate Human-Style Post
                            </button>
                            <div id="blogResults" class="mt-3"></div>
                        </div>
                    </div>
                `;
            }

            async generateBlogPost() {
                const title = document.getElementById('blogTitle').value.trim();
                const postType = document.getElementById('postType').value;
                const context = document.getElementById('blogContext').value.trim();
                
                if (!title) {
                    this.showNotification('❌ Please enter a title/topic for your post');
                    return;
                }
                
                const resultsDiv = document.getElementById('blogResults');
                resultsDiv.innerHTML = `
                    <div class="text-center p-3">
                        <div class="spinner-border text-success me-3"></div>
                        <span class="text-info">Generating ${postType} content...</span>
                    </div>
                `;
                
                try {
                    // Enhanced prompt for different post types
                    const prompts = {
                        blog: `Write a compelling, human-style blog post about "${title}". Make it engaging, informative, and authentic. Include an attention-grabbing introduction, well-structured sections, and a strong conclusion. Length: 800-1200 words.`,
                        linkedin: `Create a professional LinkedIn post about "${title}". Make it engaging, thought-provoking, and suitable for professional networking. Include relevant hashtags and encourage engagement. Length: 200-300 words.`,
                        twitter: `Create a Twitter thread about "${title}". Write 5-8 tweets that tell a compelling story or share valuable insights. Each tweet should be engaging and build on the previous one. Include relevant hashtags.`,
                        article: `Write a comprehensive technical article about "${title}". Make it detailed, well-researched, and valuable for professionals. Include examples, best practices, and actionable insights. Length: 1000-1500 words.`
                    };
                    
                    let prompt = prompts[postType];
                    if (context) {
                        prompt += `\n\nAdditional context: ${context}`;
                    }
                    
                    prompt += `\n\nWrite in a human, conversational style that sounds natural and authentic. Avoid overly promotional or artificial language.`;
                    
                    const response = await fetch('/generate-content', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: prompt,
                            type: postType,
                            title: title,
                            context: context,
                            user_id: 'Paresh'
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.displayBlogResult(result, postType, title);
                        this.showNotification(`✅ ${postType.charAt(0).toUpperCase() + postType.slice(1)} generated successfully!`);
                    } else {
                        throw new Error('Content generation service unavailable');
                    }
                } catch (error) {
                    console.error('Blog generation error:', error);
                    resultsDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <h6>⚠️ Content Generation Temporarily Unavailable</h6>
                            <p class="mb-2">Unable to connect to AI content generation service.</p>
                            <p class="mb-0"><strong>Suggested Outline for "${title}":</strong></p>
                            <ul class="mt-2">
                                <li>Introduction - Hook your audience with an interesting fact or question</li>
                                <li>Main Points - Break down your topic into 3-5 key sections</li>
                                <li>Examples & Stories - Add real-world examples or personal experiences</li>
                                <li>Conclusion - Summarize key takeaways and include a call-to-action</li>
                                ${postType === 'linkedin' ? '<li>Add 3-5 relevant hashtags</li>' : ''}
                                ${postType === 'twitter' ? '<li>Break into 5-8 tweets with engaging hooks</li>' : ''}
                            </ul>
                        </div>
                    `;
                    this.showNotification('❌ Content generation failed - showing outline instead');
                }
            }

            displayBlogResult(result, postType, title) {
                const resultsDiv = document.getElementById('blogResults');
                const content = result.content || result.response || 'Content generated successfully.';
                
                // Format the content based on post type
                let formattedContent = content;
                if (postType === 'twitter' && content.includes('\n\n')) {
                    // Format as numbered tweets
                    const tweets = content.split('\n\n').filter(tweet => tweet.trim());
                    formattedContent = tweets.map((tweet, index) => `${index + 1}/${tweets.length} ${tweet.trim()}`).join('\n\n');
                }
                
                resultsDiv.innerHTML = `
                    <div class="generated-content mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-success mb-0">
                                <i class="fas fa-check-circle me-2"></i>Generated ${postType.charAt(0).toUpperCase() + postType.slice(1)}
                            </h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-light btn-sm" onclick="window.dashboard.copyToClipboard('${postType}_content')">
                                    <i class="fas fa-copy me-1"></i>Copy
                                </button>
                                <button class="btn btn-outline-light btn-sm" onclick="window.dashboard.regenerateContent()">
                                    <i class="fas fa-redo me-1"></i>Regenerate
                                </button>
                                <button class="btn btn-success btn-sm" onclick="window.dashboard.saveGeneratedContent('${title}', '${postType}')">
                                    <i class="fas fa-save me-1"></i>Save
                                </button>
                            </div>
                        </div>
                        
                        <div class="content-preview p-3" id="${postType}_content" style="background: rgba(255,255,255,0.1); border-radius: 10px; white-space: pre-wrap; color: white; max-height: 400px; overflow-y: auto;">${formattedContent}</div>
                        
                        <div class="content-stats mt-2 small text-muted">
                            <span><i class="fas fa-align-left me-1"></i>Words: ${content.split(' ').length}</span>
                            <span class="ms-3"><i class="fas fa-clock me-1"></i>Est. reading time: ${Math.ceil(content.split(' ').length / 200)} min</span>
                            ${postType === 'twitter' ? `<span class="ms-3"><i class="fab fa-twitter me-1"></i>Tweets: ${formattedContent.split('\n\n').length}</span>` : ''}
                        </div>
                    </div>
                `;
            }

            async copyToClipboard(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    try {
                        await navigator.clipboard.writeText(element.textContent);
                        this.showNotification('📋 Content copied to clipboard!');
                    } catch (error) {
                        // Fallback for older browsers
                        element.select();
                        document.execCommand('copy');
                        this.showNotification('📋 Content copied to clipboard!');
                    }
                }
            }

            async regenerateContent() {
                this.showNotification('🔄 Regenerating content...');
                await this.generateBlogPost();
            }

            async saveGeneratedContent(title, type) {
                const content = document.getElementById(`${type}_content`).textContent;
                const data = {
                    title: title,
                    type: type,
                    content: content,
                    timestamp: new Date().toISOString(),
                    user_id: 'Paresh'
                };
                
                try {
                    const response = await fetch('/save-generated-content', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        this.showNotification('💾 Content saved successfully!');
                    } else {
                        // Fallback to local storage
                        const saved = JSON.parse(localStorage.getItem('generated_content') || '[]');
                        saved.unshift(data);
                        localStorage.setItem('generated_content', JSON.stringify(saved.slice(0, 10))); // Keep last 10
                        this.showNotification('💾 Content saved locally!');
                    }
                } catch (error) {
                    console.error('Save error:', error);
                    this.showNotification('❌ Save failed - try copying content manually');
                }
            }

            async populateDocumentSelect(selectId) {
                try {
                    const documentsResponse = await fetch('/documents').then(r => r.ok ? r.json() : []).catch(() => []);
                    const memoriesResponse = await fetch('/memories?limit=10').then(r => r.ok ? r.json() : []).catch(() => []);
                    
                    // Ensure we have arrays
                    const documents = Array.isArray(documentsResponse) ? documentsResponse : [];
                    const memories = Array.isArray(memoriesResponse) ? memoriesResponse : [];
                    
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Choose document...</option>';
                        
                        if (documents.length > 0) {
                            documents.forEach(doc => {
                                const option = document.createElement('option');
                                option.value = doc.id || doc._id || '';
                                option.textContent = doc.name || doc.filename || doc.title || 'Untitled';
                                select.appendChild(option);
                            });
                        }
                        
                        if (memories.length > 0) {
                            memories.forEach(mem => {
                                const option = document.createElement('option');
                                option.value = mem.id || mem._id || '';
                                option.textContent = mem.metadata?.filename || mem.filename || mem.title || 'Memory Document';
                                select.appendChild(option);
                            });
                        }
                        
                        if (documents.length === 0 && memories.length === 0) {
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = 'No documents available';
                            option.disabled = true;
                            select.appendChild(option);
                        }
                    }
                } catch (error) {
                    console.warn('Failed to populate documents:', error.message);
                    // Don't show technical errors to user
                }
            }

            async uploadForAnalysis(file, action) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('action', action);
                
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.showNotification(`✅ ${file.name} uploaded for ${action}`);
                        this.monitorTask(result.task_id, file.name);
                        return result.task_id;
                    }
                } catch (error) {
                    this.showNotification(`❌ Upload failed: ${error.message}`);
                }
            }

            async runDocumentAnalysis() {
                const select = document.getElementById('docSelectAnalysis');
                const upload = document.getElementById('uploadAnalysis');
                const resultsDiv = document.getElementById('analysisResults');
                
                let docId = select.value;
                
                // If file uploaded, use document analysis action
                if (upload.files[0]) {
                    const formData = new FormData();
                    formData.append('file', upload.files[0]);
                    formData.append('action', 'document_analysis');
                    
                    try {
                        const response = await fetch('/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            resultsDiv.innerHTML = `
                                <div class="alert alert-info">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Running comprehensive document analysis... This includes summary, key points, action items, questions, risks, and opportunities.
                                </div>
                            `;
                            this.monitorTaskWithCustomDisplay(result.task_id, 'analysisResults', 'displayComprehensiveAnalysis');
                            this.showNotification(`✅ ${upload.files[0].name} uploaded for comprehensive analysis`);
                        } else {
                            throw new Error('Upload failed');
                        }
                    } catch (error) {
                        this.showNotification(`❌ Upload failed: ${error.message}`);
                        console.error('Upload error:', error);
                    }
                    return;
                }
                
                if (!docId) {
                    this.showNotification('⚠️ Please select a document or upload one');
                    return;
                }
                
                try {
                    const response = await fetch(`/memory/${docId}/reprocess`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'document_analysis' })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        resultsDiv.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Running comprehensive analysis... Generating summary, key points, action items, questions, risks, and opportunities.
                            </div>
                        `;
                        this.monitorTaskWithCustomDisplay(result.task_id, 'analysisResults', 'displayComprehensiveAnalysis');
                    } else {
                        throw new Error('Analysis request failed');
                    }
                } catch (error) {
                    this.showNotification('❌ Analysis failed');
                    console.error('Analysis error:', error);
                }
            }

            async generateSmartQuestions() {
                const select = document.getElementById('docSelectQuestions');
                const upload = document.getElementById('uploadQuestions');
                const resultsDiv = document.getElementById('questionsResults');
                
                let docId = select.value;
                
                if (upload.files[0]) {
                    const formData = new FormData();
                    formData.append('file', upload.files[0]);
                    formData.append('action', 'smart_questions');
                    formData.append('question_types', JSON.stringify([
                        'analytical', 'critical_thinking', 'comprehension', 'application', 'synthesis'
                    ]));
                    formData.append('include_levels', JSON.stringify([
                        'basic', 'intermediate', 'advanced'
                    ]));
                    
                    try {
                        const response = await fetch('/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            resultsDiv.innerHTML = `
                                <div class="alert alert-info">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Generating intelligent questions... Creating analytical, critical thinking, comprehension, and application questions.
                                </div>
                            `;
                            this.monitorTaskWithCustomDisplay(result.task_id, 'questionsResults', 'displaySmartQuestions');
                            this.showNotification(`✅ ${upload.files[0].name} uploaded for smart question generation`);
                        } else {
                            throw new Error('Upload failed');
                        }
                    } catch (error) {
                        this.showNotification(`❌ Upload failed: ${error.message}`);
                        console.error('Upload error:', error);
                    }
                    return;
                }
                
                if (!docId) {
                    this.showNotification('⚠️ Please select a document or upload one');
                    return;
                }
                
                try {
                    const response = await fetch(`/memory/${docId}/reprocess`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'smart_questions',
                            question_types: ['analytical', 'critical_thinking', 'comprehension', 'application', 'synthesis'],
                            include_levels: ['basic', 'intermediate', 'advanced']
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        resultsDiv.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Generating intelligent questions across multiple difficulty levels and question types...
                            </div>
                        `;
                        this.monitorTaskWithCustomDisplay(result.task_id, 'questionsResults', 'displaySmartQuestions');
                    } else {
                        throw new Error('Question generation request failed');
                    }
                } catch (error) {
                    this.showNotification('❌ Question generation failed');
                    console.error('Question generation error:', error);
                }
            }

            async generateEmailDraft() {
                const select = document.getElementById('docSelectEmail');
                const upload = document.getElementById('uploadEmail');
                const context = document.getElementById('emailContext').value;
                const resultsDiv = document.getElementById('emailResults');
                
                let docId = select.value;
                
                if (upload.files[0]) {
                    const taskId = await this.uploadForAnalysis(upload.files[0], 'email_drafting');
                    if (taskId) {
                        resultsDiv.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Generating email draft... Results will appear here.
                            </div>
                        `;
                    }
                    return;
                }
                
                if (!docId && !context) {
                    this.showNotification('⚠️ Please select a document or provide email context');
                    return;
                }
                
                try {
                    let response;
                    if (docId) {
                        response = await fetch(`/memory/${docId}/reprocess`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'email_drafting', context: context })
                        });
                    } else {
                        response = await fetch('/process-text', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                text: context,
                                action: 'email_drafting',
                                user_id: 'Paresh'
                            })
                        });
                    }
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.task_id) {
                            resultsDiv.innerHTML = `
                                <div class="alert alert-info">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Crafting professional email...
                                </div>
                            `;
                            this.monitorTaskWithResult(result.task_id, 'emailResults');
                        } else {
                            resultsDiv.innerHTML = `
                                <div class="alert alert-success">
                                    <h6>📧 Email Draft:</h6>
                                    <div class="mt-3 p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                                        ${result.result || result.analysis}
                                    </div>
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    this.showNotification('❌ Email generation failed');
                }
            }

            async processMeetingTranscript() {
                const upload = document.getElementById('uploadMeeting');
                const resultsDiv = document.getElementById('meetingResults');
                
                if (!upload.files[0]) {
                    this.showNotification('⚠️ Please upload a meeting transcript');
                    return;
                }
                
                const taskId = await this.uploadForAnalysis(upload.files[0], 'meeting_processing');
                if (taskId) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Processing meeting transcript... Extracting action items, key points, and decisions.
                        </div>
                    `;
                    this.monitorTaskWithResult(taskId, 'meetingResults');
                }
            }

            async generateBlogPost() {
                const title = document.getElementById('blogTitle').value;
                const postType = document.getElementById('postType').value;
                const context = document.getElementById('blogContext').value;
                const resultsDiv = document.getElementById('blogResults');
                
                if (!title) {
                    this.showNotification('⚠️ Please enter a title or topic');
                    return;
                }
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Generating professional ${postType}... Creating engaging, human-style content.
                    </div>
                `;
                
                try {
                    // Enhanced prompts for different content types
                    const prompts = {
                        blog: `Write a compelling, human-style blog post about "${title}". Make it engaging, informative, and authentic. Include an attention-grabbing introduction, well-structured sections with subheadings, real-world examples, and a strong conclusion. Length: 800-1200 words. Use a conversational tone that connects with readers.`,
                        linkedin: `Create a professional LinkedIn post about "${title}". Make it engaging, thought-provoking, and suitable for professional networking. Include insights, personal perspective, and relevant hashtags. Encourage engagement with a question or call-to-action. Length: 200-300 words.`,
                        twitter: `Create a Twitter thread about "${title}". Write 5-8 tweets that tell a compelling story or share valuable insights. Each tweet should be under 280 characters, engaging, and build on the previous one. Include relevant hashtags and emojis where appropriate.`,
                        article: `Write a comprehensive technical article about "${title}". Make it detailed, well-researched, and valuable for professionals. Include examples, best practices, actionable insights, and proper structure with headings. Length: 1000-1500 words.`,
                        newsletter: `Create a newsletter section about "${title}". Write in a friendly, informative tone with clear value for subscribers. Include key insights, actionable tips, and engaging content. Length: 400-600 words.`
                    };
                    
                    let prompt = prompts[postType] || prompts.blog;
                    if (context) {
                        prompt += `\n\nAdditional context and requirements: ${context}`;
                    }
                    
                    prompt += `\n\nWrite in a natural, human style that sounds authentic and engaging. Avoid overly promotional or artificial language. Focus on providing genuine value to readers.`;
                    
                    // Try the generate-content endpoint first, fallback to process-text
                    let response;
                    try {
                        response = await fetch('/generate-content', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                prompt: prompt,
                                content_type: postType,
                                title: title,
                                context: context,
                                user_id: 'Paresh'
                            })
                        });
                    } catch (error) {
                        console.log('Generate-content failed, trying process-text fallback');
                        response = await fetch('/process-text', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                content: prompt,
                                action: 'document_analysis',
                                user_id: 'Paresh'
                            })
                        });
                    }
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.task_id) {
                            this.monitorTaskWithCustomDisplay(result.task_id, 'blogResults', 'displayBlogContent');
                        } else {
                            this.displayBlogContent(result, title, postType, 'blogResults');
                        }
                        this.showNotification(`✅ ${postType.charAt(0).toUpperCase() + postType.slice(1)} generated successfully!`);
                    } else {
                        throw new Error('Content generation service unavailable');
                    }
                } catch (error) {
                    console.error('Blog generation error:', error);
                    resultsDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <h6>⚠️ Content Generation Temporarily Unavailable</h6>
                            <p class="mb-2">Unable to connect to AI content generation service.</p>
                            <p class="mb-0"><strong>Suggested Outline for "${title}":</strong></p>
                            <ul class="mt-2">
                                <li>Introduction - Hook your audience with an interesting fact or question</li>
                                <li>Main Points - Break down your topic into 3-5 key sections</li>
                                <li>Examples & Stories - Add real-world examples or personal experiences</li>
                                <li>Conclusion - Summarize key takeaways and include a call-to-action</li>
                                ${postType === 'linkedin' ? '<li>Add 3-5 relevant hashtags</li>' : ''}
                                ${postType === 'twitter' ? '<li>Break into 5-8 tweets with engaging hooks</li>' : ''}
                                ${postType === 'newsletter' ? '<li>Include subscriber-focused value and actionable tips</li>' : ''}
                            </ul>
                            <button class="btn btn-outline-light btn-sm mt-3" onclick="window.dashboard.generateBlogPost()">
                                <i class="fas fa-redo me-1"></i>Try Again
                            </button>
                        </div>
                    `;
                    this.showNotification('❌ Content generation failed - showing outline instead');
                }
            }

            async monitorTaskWithResult(taskId, resultDivId) {
                const checkInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`/task/${taskId}`);
                        if (response.ok) {
                            const task = await response.json();
                            
                            if (task.status === 'completed') {
                                clearInterval(checkInterval);
                                const resultDiv = document.getElementById(resultDivId);
                                if (resultDiv && task.result) {
                                    // Try to parse and format the result properly
                                    let formattedResult = task.result;
                                    
                                    try {
                                        // Special formatting for different result types
                                        if (resultDivId.includes('questions')) {
                                            formattedResult = this.formatQuestionsResult(task.result);
                                        } else if (typeof task.result === 'string' && task.result.startsWith('{')) {
                                            const parsedResult = JSON.parse(task.result);
                                            formattedResult = this.formatAnalysisResult(parsedResult);
                                        } else if (typeof task.result === 'object') {
                                            formattedResult = this.formatAnalysisResult(task.result);
                                        } else {
                                            // Format as markdown-like text
                                            formattedResult = task.result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                                        }
                                    } catch (e) {
                                        // If parsing fails, use as-is but format line breaks
                                        formattedResult = task.result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                                    }
                                    
                                    resultDiv.innerHTML = `
                                        <div class="alert alert-success">
                                            <h6>✅ Analysis Complete:</h6>
                                            <div class="mt-3 p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px; max-height: 400px; overflow-y: auto;">
                                                ${formattedResult}
                                            </div>
                                        </div>
                                    `;
                                    
                                    // Also add to workspace recent activity and results history
                                    this.addToWorkspaceActivity('Document Analysis', `Analysis completed for ${task.filename || 'document'}`, task.result);
                                    this.addToResultsHistory(resultDivId.replace('Results', ''), task.filename || 'document', formattedResult);
                                }
                            } else if (task.status === 'failed') {
                                clearInterval(checkInterval);
                                const resultDiv = document.getElementById(resultDivId);
                                if (resultDiv) {
                                    resultDiv.innerHTML = `
                                        <div class="alert alert-danger">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Processing failed. Please try again.
                                        </div>
                                    `;
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('Task monitoring error:', error);
                    }
                }, 2000);
                
                setTimeout(() => clearInterval(checkInterval), 300000);
            }

            startLiveRecording() {
                // Integrate with existing voice system
                if (this.voiceProcessor) {
                    this.voiceProcessor.startRecording().then(() => {
                        this.showNotification('🎙️ Live recording started - speak now');
                        
                        const resultsDiv = document.getElementById('meetingResults');
                        resultsDiv.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-microphone text-danger me-2"></i>
                                Recording live meeting... Click the voice button to stop.
                            </div>
                        `;
                    }).catch(error => {
                        this.showNotification('❌ Failed to start recording');
                    });
                } else {
                    this.showNotification('⚠️ Voice system not initialized');
                }
            }

            formatAnalysisResult(result) {
                if (typeof result === 'string') {
                    return result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                }
                
                if (typeof result === 'object') {
                    let formatted = '';
                    
                    if (result.summary) {
                        formatted += `<h6>📄 Summary</h6><p>${result.summary}</p>`;
                    }
                    
                    if (result.key_points) {
                        formatted += `<h6>🎯 Key Points</h6><ul>`;
                        result.key_points.forEach(point => {
                            formatted += `<li>${point}</li>`;
                        });
                        formatted += `</ul>`;
                    }
                    
                    if (result.action_items) {
                        formatted += `<h6>✅ Action Items</h6><ul>`;
                        result.action_items.forEach(item => {
                            formatted += `<li>${item}</li>`;
                        });
                        formatted += `</ul>`;
                    }
                    
                    if (result.recommendations) {
                        formatted += `<h6>💡 Recommendations</h6><ul>`;
                        result.recommendations.forEach(rec => {
                            formatted += `<li>${rec}</li>`;
                        });
                        formatted += `</ul>`;
                    }
                    
                    return formatted || JSON.stringify(result, null, 2).replace(/\n/g, '<br>');
                }
                
                return String(result);
            }

            formatQuestionsResult(result) {
                let formatted = '';
                
                if (typeof result === 'string') {
                    // Try to extract questions from the text
                    const text = result;
                    const questionLines = text.split('\n').filter(line => 
                        line.trim().includes('?') || 
                        line.toLowerCase().includes('question') ||
                        /^\d+\./.test(line.trim())
                    );
                    
                    if (questionLines.length > 0) {
                        formatted += `<h6>❓ Generated Questions</h6><div class="questions-list">`;
                        questionLines.forEach((question, index) => {
                            const cleanQuestion = question.replace(/^\d+\.?\s*/, '').trim();
                            if (cleanQuestion) {
                                formatted += `
                                    <div class="question-item mb-3 p-3" style="background: var(--surface-bg); border-radius: 8px; border-left: 4px solid var(--info-color);">
                                        <div class="fw-bold" style="color: var(--text-primary);">${index + 1}. ${cleanQuestion}</div>
                                    </div>
                                `;
                            }
                        });
                        formatted += `</div>`;
                    } else {
                        formatted = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    }
                } else if (typeof result === 'object' && result.questions) {
                    formatted += `<h6>❓ Generated Questions</h6><div class="questions-list">`;
                    result.questions.forEach((question, index) => {
                        formatted += `
                            <div class="question-item mb-3 p-3" style="background: var(--surface-bg); border-radius: 8px; border-left: 4px solid var(--info-color);">
                                <div class="fw-bold" style="color: var(--text-primary);">${index + 1}. ${question}</div>
                            </div>
                        `;
                    });
                    formatted += `</div>`;
                } else {
                    // Fallback formatting
                    formatted = String(result).replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                }
                
                return formatted;
            }

            addToWorkspaceActivity(type, description, details = '') {
                try {
                    const activity = {
                        type: type.toLowerCase().replace(/\s+/g, '_'),
                        description: description,
                        timestamp: new Date().toISOString(),
                        details: details
                    };
                    
                    // Store in localStorage for persistence
                    let activities = JSON.parse(localStorage.getItem('workspaceActivities') || '[]');
                    activities.unshift(activity);
                    activities = activities.slice(0, 10); // Keep only last 10
                    localStorage.setItem('workspaceActivities', JSON.stringify(activities));
                    
                    // Refresh the workspace display
                    this.loadRealDocuments();
                } catch (error) {
                    console.warn('Failed to add workspace activity:', error);
                }
            }

            async monitorTaskWithCustomDisplay(taskId, resultDivId, displayFunction) {
                let attemptCount = 0;
                const maxAttempts = 150; // 5 minutes with 2-second intervals
                
                const checkInterval = setInterval(async () => {
                    attemptCount++;
                    
                    try {
                        const response = await fetch(`/task/${taskId}`);
                        if (response.ok) {
                            const task = await response.json();
                            console.log(`📊 Task ${taskId} status:`, task.status, `progress: ${task.progress}%`);
                            
                            if (task.status === 'completed') {
                                clearInterval(checkInterval);
                                console.log(`✅ Task ${taskId} completed:`, task);
                                
                                // Use the custom display function
                                if (typeof this[displayFunction] === 'function') {
                                    this[displayFunction](task.result, task.filename || 'document', resultDivId);
                                } else {
                                    // Fallback to default display
                                    const resultDiv = document.getElementById(resultDivId);
                                    if (resultDiv && task.result) {
                                        resultDiv.innerHTML = this.formatTaskResult(task.result, task.filename);
                                    }
                                }
                                
                                this.addNotification(`Analysis complete`, 'success', 'Task Complete');
                                this.loadRealDocuments();
                                this.loadRealInsights();
                                
                            } else if (task.status === 'failed' || task.status === 'error') {
                                clearInterval(checkInterval);
                                console.log(`❌ Task ${taskId} failed:`, task.error_message);
                                
                                const resultDiv = document.getElementById(resultDivId);
                                if (resultDiv) {
                                    resultDiv.innerHTML = `
                                        <div class="alert alert-danger">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Processing failed: ${task.error_message || 'Unknown error'}
                                        </div>
                                    `;
                                }
                                
                                this.addNotification(`Analysis failed: ${task.error_message || 'Unknown error'}`, 'error', 'Analysis Failed');
                            }
                            
                        } else {
                            console.warn(`Failed to fetch task ${taskId}:`, response.status);
                        }
                    } catch (error) {
                        console.warn('Task monitoring error:', error);
                        if (attemptCount > 10) {
                            this.addNotification(`Monitoring connection issues`, 'warning', 'Connection');
                        }
                    }
                    
                    // Stop monitoring after max attempts
                    if (attemptCount >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.log(`⏰ Task monitoring timeout for ${taskId}`);
                        this.addNotification(`Monitoring timeout - task may still be running`, 'warning', 'Timeout');
                    }
                }, 2000);
            }

            displayComprehensiveAnalysis(content, filename, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                let analysisData = content;
                
                // Parse content if it's a string
                if (typeof content === 'string') {
                    try {
                        analysisData = JSON.parse(content);
                    } catch (e) {
                        // If not JSON, treat as plain text analysis
                        analysisData = { summary: content };
                    }
                }
                
                // Extract sections from the document_analysis structure
                const sections = {
                    summary: analysisData.summary || '',
                    key_points: analysisData.key_points || [],
                    action_items: analysisData.action_items || [],
                    questions: analysisData.questions || [],
                    risks: analysisData.risks || [],
                    opportunities: analysisData.opportunities || []
                };
                
                container.innerHTML = `
                    <div class="comprehensive-analysis">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-chart-line me-3" style="font-size: 2rem; color: var(--success-color);"></i>
                                <div>
                                    <h4 style="color: var(--text-primary); margin: 0;">Comprehensive Analysis</h4>
                                    <p style="color: var(--text-secondary); margin: 0;">${filename}</p>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="window.dashboard.copyToClipboard('comprehensive_analysis_content')">
                                    <i class="fas fa-copy me-1"></i>Copy
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="window.dashboard.downloadAnalysis('${filename}')">
                                    <i class="fas fa-download me-1"></i>Download
                                </button>
                            </div>
                        </div>
                        
                        <div id="comprehensive_analysis_content" class="analysis-sections">
                            ${sections.summary ? `
                                <div class="analysis-section mb-4 p-4" style="background: var(--surface-bg); border-radius: 12px; border-left: 4px solid var(--primary-blue);">
                                    <h5 style="color: var(--primary-blue); margin-bottom: 16px;">
                                        <i class="fas fa-clipboard-list me-2"></i>Document Summary
                                    </h5>
                                    <div style="color: var(--text-primary); line-height: 1.7; white-space: pre-wrap;">${sections.summary}</div>
                                </div>
                            ` : ''}
                            
                            ${sections.key_points && sections.key_points.length > 0 ? `
                                <div class="analysis-section mb-4 p-4" style="background: var(--surface-bg); border-radius: 12px; border-left: 4px solid var(--info-color);">
                                    <h5 style="color: var(--info-color); margin-bottom: 16px;">
                                        <i class="fas fa-lightbulb me-2"></i>Key Points
                                    </h5>
                                    <ul style="color: var(--text-primary); line-height: 1.7;">
                                        ${Array.isArray(sections.key_points) ? 
                                            sections.key_points.map(point => `<li>${point}</li>`).join('') :
                                            `<li>${sections.key_points}</li>`
                                        }
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${sections.action_items && sections.action_items.length > 0 ? `
                                <div class="analysis-section mb-4 p-4" style="background: var(--surface-bg); border-radius: 12px; border-left: 4px solid var(--success-color);">
                                    <h5 style="color: var(--success-color); margin-bottom: 16px;">
                                        <i class="fas fa-tasks me-2"></i>Action Items
                                    </h5>
                                    <ul style="color: var(--text-primary); line-height: 1.7;">
                                        ${Array.isArray(sections.action_items) ? 
                                            sections.action_items.map(item => `<li>${typeof item === 'object' ? item.description || item.text || JSON.stringify(item) : item}</li>`).join('') :
                                            `<li>${sections.action_items}</li>`
                                        }
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${sections.questions && sections.questions.length > 0 ? `
                                <div class="analysis-section mb-4 p-4" style="background: var(--surface-bg); border-radius: 12px; border-left: 4px solid var(--warning-color);">
                                    <h5 style="color: var(--warning-color); margin-bottom: 16px;">
                                        <i class="fas fa-question-circle me-2"></i>Generated Questions
                                    </h5>
                                    <ul style="color: var(--text-primary); line-height: 1.7;">
                                        ${Array.isArray(sections.questions) ? 
                                            sections.questions.map(q => `<li>${typeof q === 'object' ? q.question || q.text || JSON.stringify(q) : q}</li>`).join('') :
                                            `<li>${sections.questions}</li>`
                                        }
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${sections.risks && sections.risks.length > 0 ? `
                                <div class="analysis-section mb-4 p-4" style="background: var(--surface-bg); border-radius: 12px; border-left: 4px solid var(--error-color);">
                                    <h5 style="color: var(--error-color); margin-bottom: 16px;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Identified Risks
                                    </h5>
                                    <ul style="color: var(--text-primary); line-height: 1.7;">
                                        ${Array.isArray(sections.risks) ? 
                                            sections.risks.map(risk => `<li>${risk}</li>`).join('') :
                                            `<li>${sections.risks}</li>`
                                        }
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${sections.opportunities && sections.opportunities.length > 0 ? `
                                <div class="analysis-section mb-4 p-4" style="background: var(--surface-bg); border-radius: 12px; border-left: 4px solid var(--secondary-blue);">
                                    <h5 style="color: var(--secondary-blue); margin-bottom: 16px;">
                                        <i class="fas fa-star me-2"></i>Opportunities
                                    </h5>
                                    <ul style="color: var(--text-primary); line-height: 1.7;">
                                        ${Array.isArray(sections.opportunities) ? 
                                            sections.opportunities.map(opp => `<li>${opp}</li>`).join('') :
                                            `<li>${sections.opportunities}</li>`
                                        }
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="analysis-metadata mt-3" style="background: var(--card-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <small style="color: var(--text-muted);">Analysis completed: ${new Date().toLocaleString()}</small>
                        </div>
                    </div>
                `;
                
                // Add to results history
                this.addToResultsHistory('comprehensive_analysis', filename, container.innerHTML);
            }

            displaySmartQuestions(content, filename, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                let questionsData = content;
                
                // Parse content if it's a string
                if (typeof content === 'string') {
                    try {
                        questionsData = JSON.parse(content);
                    } catch (e) {
                        // Extract questions from plain text
                        const questionPattern = /(?:^\d+\.?\s*|Question\s*\d*:?\s*)(.*?\?)/gmi;
                        const matches = content.match(questionPattern) || [];
                        questionsData = { questions: matches.map(q => q.replace(/^\d+\.?\s*|Question\s*\d*:?\s*/i, '').trim()) };
                    }
                }
                
                // Organize questions by type/level if available
                const questions = questionsData.questions || questionsData || [];
                const questionTypes = {
                    analytical: questions.filter((_, i) => i % 4 === 0),
                    critical_thinking: questions.filter((_, i) => i % 4 === 1),
                    comprehension: questions.filter((_, i) => i % 4 === 2),
                    application: questions.filter((_, i) => i % 4 === 3)
                };
                
                container.innerHTML = `
                    <div class="smart-questions">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-question-circle me-3" style="font-size: 2rem; color: var(--info-color);"></i>
                                <div>
                                    <h4 style="color: var(--text-primary); margin: 0;">Smart Questions</h4>
                                    <p style="color: var(--text-secondary); margin: 0;">${filename}</p>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="window.dashboard.copyToClipboard('smart_questions_content')">
                                    <i class="fas fa-copy me-1"></i>Copy Questions
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="window.dashboard.generateMoreQuestions('${filename}')">
                                    <i class="fas fa-plus me-1"></i>Generate More
                                </button>
                            </div>
                        </div>
                        
                        <div id="smart_questions_content" class="questions-grid">
                            ${Array.isArray(questions) && questions.length > 0 ? 
                                questions.map((question, index) => `
                                    <div class="question-card mb-3 p-3" style="background: var(--surface-bg); border-radius: 10px; border-left: 4px solid var(--info-color);">
                                        <div class="question-header d-flex justify-content-between align-items-start mb-2">
                                            <span class="question-number" style="color: var(--info-color); font-weight: bold;">Q${index + 1}</span>
                                            <span class="question-type badge" style="background: var(--info-color); color: white; font-size: 0.75rem;">
                                                ${this.getQuestionType(index)}
                                            </span>
                                        </div>
                                        <div class="question-text" style="color: var(--text-primary); font-size: 1.05rem; line-height: 1.6;">
                                            ${question}
                                        </div>
                                    </div>
                                `).join('') :
                                '<div class="text-muted">No questions generated. Try uploading a different document.</div>'
                            }
                        </div>
                        
                        <div class="questions-summary mt-4 p-3" style="background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div class="row text-center">
                                <div class="col">
                                    <div style="color: var(--info-color); font-size: 1.5rem; font-weight: bold;">${questions.length}</div>
                                    <small style="color: var(--text-muted);">Total Questions</small>
                                </div>
                                <div class="col">
                                    <div style="color: var(--success-color); font-size: 1.5rem; font-weight: bold;">${Math.ceil(questions.length / 4)}</div>
                                    <small style="color: var(--text-muted);">Question Types</small>
                                </div>
                                <div class="col">
                                    <div style="color: var(--warning-color); font-size: 1.5rem; font-weight: bold;">${Math.ceil(questions.length * 0.3)}</div>
                                    <small style="color: var(--text-muted);">Est. Study Time (min)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add to results history
                this.addToResultsHistory('smart_questions', filename, container.innerHTML);
            }

            displayBlogContent(content, title, postType, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                let blogContent = content;
                
                // Extract content from result object
                if (typeof content === 'object') {
                    blogContent = content.content || content.result || content.response || content.analysis || '';
                }
                
                // Format content based on post type
                let formattedContent = blogContent;
                if (postType === 'twitter' && blogContent.includes('\n\n')) {
                    // Format as numbered tweets
                    const tweets = blogContent.split('\n\n').filter(tweet => tweet.trim());
                    formattedContent = tweets.map((tweet, index) => `${index + 1}/${tweets.length} ${tweet.trim()}`).join('\n\n');
                }
                
                container.innerHTML = `
                    <div class="blog-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-edit me-3" style="font-size: 2rem; color: var(--success-color);"></i>
                                <div>
                                    <h4 style="color: var(--text-primary); margin: 0;">Generated ${postType.charAt(0).toUpperCase() + postType.slice(1)}</h4>
                                    <p style="color: var(--text-secondary); margin: 0;">${title}</p>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="window.dashboard.copyToClipboard('blog_content_text')">
                                    <i class="fas fa-copy me-1"></i>Copy
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="window.dashboard.regenerateContent('${title}', '${postType}')">
                                    <i class="fas fa-redo me-1"></i>Regenerate
                                </button>
                                <button class="btn btn-success btn-sm" onclick="window.dashboard.saveBlogContent('${title}', '${postType}')">
                                    <i class="fas fa-save me-1"></i>Save
                                </button>
                            </div>
                        </div>
                        
                        <div class="content-preview p-4" id="blog_content_text" style="background: var(--surface-bg); border-radius: 12px; border: 1px solid var(--border-color); max-height: 500px; overflow-y: auto;">
                            <div style="color: var(--text-primary); line-height: 1.7; white-space: pre-wrap; font-size: 15px;">${formattedContent}</div>
                        </div>
                        
                        <div class="content-stats mt-3 p-3" style="background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div class="row text-center">
                                <div class="col">
                                    <div style="color: var(--info-color); font-size: 1.2rem; font-weight: bold;">${formattedContent.split(' ').length}</div>
                                    <small style="color: var(--text-muted);">Words</small>
                                </div>
                                <div class="col">
                                    <div style="color: var(--success-color); font-size: 1.2rem; font-weight: bold;">${Math.ceil(formattedContent.split(' ').length / 200)}</div>
                                    <small style="color: var(--text-muted);">Est. Reading Time (min)</small>
                                </div>
                                ${postType === 'twitter' ? `
                                    <div class="col">
                                        <div style="color: var(--warning-color); font-size: 1.2rem; font-weight: bold;">${formattedContent.split('\n\n').length}</div>
                                        <small style="color: var(--text-muted);">Tweets</small>
                                    </div>
                                ` : ''}
                                <div class="col">
                                    <div style="color: var(--primary-blue); font-size: 1.2rem; font-weight: bold;">${postType.toUpperCase()}</div>
                                    <small style="color: var(--text-muted);">Content Type</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add to results history
                this.addToResultsHistory('blog_content', title, container.innerHTML);
            }

            getQuestionType(index) {
                const types = ['Analytical', 'Critical Thinking', 'Comprehension', 'Application'];
                return types[index % types.length];
            }

            formatTaskResult(result, filename) {
                return `
                    <div class="alert alert-success">
                        <h6>✅ Analysis Complete for ${filename || 'document'}:</h6>
                        <div class="mt-3 p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px; max-height: 400px; overflow-y: auto;">
                            ${typeof result === 'string' ? result.replace(/\n/g, '<br>') : JSON.stringify(result, null, 2).replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            }

            copyToClipboard(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    navigator.clipboard.writeText(element.textContent).then(() => {
                        this.showNotification('✅ Copied to clipboard');
                    }).catch(() => {
                        this.showNotification('❌ Failed to copy');
                    });
                }
            }

            toggleSidebar() {
                const sidebar = document.getElementById('smartSidebar');
                const mainContent = document.getElementById('mainContent');
                const toggleIcon = document.querySelector('.sidebar-toggle i');
                
                if (sidebar.classList.contains('collapsed')) {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('sidebar-collapsed');
                    toggleIcon.className = 'fas fa-bars';
                } else {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('sidebar-collapsed');
                    toggleIcon.className = 'fas fa-chevron-right';
                }
            }

            toggleVoiceRecording() {
                const btn = document.getElementById('voiceToggleBtn');
                const status = document.getElementById('voiceStatus');
                const preview = document.getElementById('voiceTranscriptPreview');
                
                if (this.voiceProcessor && this.voiceProcessor.isRecording) {
                    // Stop recording
                    this.voiceProcessor.stopRecording();
                    btn.innerHTML = '<i class="fas fa-microphone me-1"></i>Start';
                    btn.className = 'btn btn-outline-info btn-sm flex-fill';
                    status.style.background = '#6c757d';
                    preview.textContent = 'Voice recording stopped. Ready to listen...';
                } else {
                    // Start recording
                    if (this.voiceProcessor) {
                        this.voiceProcessor.startRecording().then(() => {
                            btn.innerHTML = '<i class="fas fa-stop me-1"></i>Stop';
                            btn.className = 'btn btn-outline-danger btn-sm flex-fill';
                            status.style.background = '#dc3545';
                            status.style.animation = 'blink 1s infinite';
                            preview.textContent = 'Listening... Speak now.';
                        }).catch(error => {
                            this.showNotification('❌ Failed to start voice recording');
                            console.error('Voice recording error:', error);
                        });
                    } else {
                        this.showNotification('⚠️ Voice processor not initialized');
                    }
                }
            }

            clearVoiceTranscript() {
                const preview = document.getElementById('voiceTranscriptPreview');
                preview.textContent = 'Ready to listen...';
                
                // Clear any stored transcripts
                if (this.voiceProcessor) {
                    // Reset voice processor state if needed
                    console.log('Voice transcript cleared');
                }
                
                this.showNotification('🗑️ Voice transcript cleared');
            }

            updateVoicePreview(text) {
                const preview = document.getElementById('voiceTranscriptPreview');
                if (preview && text) {
                    // Show only the last few words to keep it compact
                    const words = text.split(' ');
                    const lastWords = words.slice(-10).join(' ');
                    preview.textContent = lastWords + (words.length > 10 ? '...' : '');
                }
            }

            showToolPanel(toolType) {
                const workArea = document.getElementById('activeWorkArea');
                let content = '';

                switch(toolType) {
                    case 'analysis':
                        content = this.getAnalysisPanel();
                        break;
                    case 'questions':
                        content = this.getQuestionsPanel();
                        break;
                    case 'email':
                        content = this.getEmailPanel();
                        break;
                    case 'meeting':
                        content = this.getMeetingPanel();
                        break;
                    case 'blog':
                        content = this.getBlogPanel();
                        break;
                }

                workArea.innerHTML = content;
                this.setupToolEventListeners(toolType);
            }

            getAnalysisPanel() {
                return `
                    <div class="tool-panel">
                        <div class="d-flex align-items-center mb-4">
                            <i class="fas fa-search me-3" style="font-size: 2rem; color: var(--primary-blue);"></i>
                            <div>
                                <h4 style="color: var(--text-primary); margin: 0;">Document Analysis</h4>
                                <p style="color: var(--text-secondary); margin: 0;">Comprehensive AI-powered document analysis</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold" style="color: var(--text-primary);">Select Document</label>
                                    <select class="form-select" id="docSelectAnalysis" style="background: var(--surface-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                        <option value="">Choose from uploaded documents...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold" style="color: var(--text-primary);">Upload New Document</label>
                                    <input type="file" id="uploadAnalysis" class="form-control" style="background: var(--surface-bg); border: 1px solid var(--border-color); color: var(--text-primary);" accept=".pdf,.docx,.txt">
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mb-4">
                            <button class="btn btn-primary" onclick="window.dashboard.runDocumentAnalysis()">
                                <i class="fas fa-search me-2"></i>Run Analysis
                            </button>
                            <button class="btn btn-outline-secondary" onclick="window.dashboard.viewDocumentLibrary()">
                                <i class="fas fa-folder me-2"></i>Document Library
                            </button>
                        </div>

                        <div id="analysisResults" class="results-area"></div>
                    </div>
                `;
            }

            getQuestionsPanel() {
                return `
                    <div class="tool-panel">
                        <div class="d-flex align-items-center mb-4">
                            <i class="fas fa-question-circle me-3" style="font-size: 2rem; color: var(--primary-blue);"></i>
                            <div>
                                <h4 style="color: var(--text-primary); margin: 0;">Smart Questions</h4>
                                <p style="color: var(--text-secondary); margin: 0;">Generate intelligent questions from your documents</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold" style="color: var(--text-primary);">Select Document</label>
                                    <select class="form-select" id="docSelectQuestions" style="background: var(--surface-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                        <option value="">Choose from uploaded documents...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold" style="color: var(--text-primary);">Upload New Document</label>
                                    <input type="file" id="uploadQuestions" class="form-control" style="background: var(--surface-bg); border: 1px solid var(--border-color); color: var(--text-primary);" accept=".pdf,.docx,.txt">
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mb-4">
                            <button class="btn btn-primary" onclick="window.dashboard.generateSmartQuestions()">
                                <i class="fas fa-question-circle me-2"></i>Generate Questions
                            </button>
                        </div>

                        <div id="questionsResults" class="results-area"></div>
                    </div>
                `;
            }

            getMeetingPanel() {
                return `
                    <div class="tool-panel">
                        <div class="d-flex align-items-center mb-4">
                            <i class="fas fa-microphone me-3" style="font-size: 2rem; color: var(--primary-blue);"></i>
                            <div>
                                <h4 style="color: var(--text-primary); margin: 0;">Meeting Processor</h4>
                                <p style="color: var(--text-secondary); margin: 0;">Record live meetings or analyze transcripts</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold" style="color: var(--text-primary);">Live Recording</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success flex-fill" id="liveRecordBtn" onclick="window.dashboard.toggleLiveRecording()">
                                            <i class="fas fa-microphone me-2"></i>Start Recording
                                        </button>
                                        <div class="status-indicator" id="recordingStatus" style="background: #6c757d; width: 16px; height: 16px; border-radius: 50%; align-self: center;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold" style="color: var(--text-primary);">Upload Transcript</label>
                                    <input type="file" id="uploadMeeting" class="form-control" style="background: var(--surface-bg); border: 1px solid var(--border-color); color: var(--text-primary);" accept=".pdf,.docx,.txt">
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mb-4">
                            <button class="btn btn-info" onclick="window.dashboard.processMeetingTranscript()">
                                <i class="fas fa-cogs me-2"></i>Process Meeting
                            </button>
                            <button class="btn btn-outline-secondary" onclick="window.dashboard.viewMeetingHistory()">
                                <i class="fas fa-history me-2"></i>Meeting History
                            </button>
                        </div>

                        <div id="meetingResults" class="results-area"></div>
                    </div>
                `;
            }

            toggleResultsPanel() {
                const panel = document.getElementById('resultsPanel');
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    this.loadResultsHistory();
                } else {
                    panel.style.display = 'none';
                }
            }

            getEmailPanel() {
                return `
                    <div class="tool-panel">
                        <div class="d-flex align-items-center mb-4">
                            <i class="fas fa-envelope me-3" style="font-size: 2rem; color: var(--primary-blue);"></i>
                            <div>
                                <h4 style="color: var(--text-primary); margin: 0;">Email Assistant</h4>
                                <p style="color: var(--text-secondary); margin: 0;">Generate professional emails from your documents</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold" style="color: var(--text-primary);">Select Document</label>
                                    <select class="form-select" id="docSelectEmail" style="background: var(--surface-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                        <option value="">Choose from uploaded documents...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold" style="color: var(--text-primary);">Upload New Document</label>
                                    <input type="file" id="uploadEmail" class="form-control" style="background: var(--surface-bg); border: 1px solid var(--border-color); color: var(--text-primary);" accept=".pdf,.docx,.txt">
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label class="form-label fw-bold" style="color: var(--text-primary);">Email Context</label>
                            <textarea class="form-control" id="emailContext" rows="3" placeholder="Describe the purpose of the email..." style="background: var(--surface-bg); border: 1px solid var(--border-color); color: var(--text-primary);"></textarea>
                        </div>

                        <div class="d-flex gap-2 mb-4">
                            <button class="btn btn-primary" onclick="window.dashboard.generateEmailDraft()">
                                <i class="fas fa-envelope me-2"></i>Generate Email
                            </button>
                        </div>

                        <div id="emailResults" class="results-area"></div>
                    </div>
                `;
            }

            getBlogPanel() {
                return `
                    <div class="tool-panel">
                        <div class="d-flex align-items-center mb-4">
                            <i class="fas fa-edit me-3" style="font-size: 2rem; color: var(--primary-blue);"></i>
                            <div>
                                <h4 style="color: var(--text-primary); margin: 0;">Content Generator</h4>
                                <p style="color: var(--text-secondary); margin: 0;">Create blog posts and social media content</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold" style="color: var(--text-primary);">Post Title/Topic</label>
                                    <input type="text" class="form-control" id="blogTitle" placeholder="Enter your blog post title or topic..." style="background: var(--surface-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold" style="color: var(--text-primary);">Content Type</label>
                                    <select class="form-select" id="postType" style="background: var(--surface-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                        <option value="blog">Blog Post</option>
                                        <option value="linkedin">LinkedIn Post</option>
                                        <option value="twitter">Twitter Thread</option>
                                        <option value="article">Technical Article</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label class="form-label fw-bold" style="color: var(--text-primary);">Additional Context</label>
                            <textarea class="form-control" id="blogContext" rows="3" placeholder="Any specific points, audience, or style you want..." style="background: var(--surface-bg); border: 1px solid var(--border-color); color: var(--text-primary);"></textarea>
                        </div>

                        <div class="d-flex gap-2 mb-4">
                            <button class="btn btn-primary" onclick="window.dashboard.generateBlogPost()">
                                <i class="fas fa-edit me-2"></i>Generate Content
                            </button>
                        </div>

                        <div id="blogResults" class="results-area"></div>
                    </div>
                `;
            }

            setupToolEventListeners(toolType) {
                // Set up file upload listeners
                switch(toolType) {
                    case 'analysis':
                        document.getElementById('uploadAnalysis')?.addEventListener('change', (e) => {
                            if (e.target.files[0]) {
                                this.uploadForAnalysis(e.target.files[0], 'document_analysis');
                            }
                        });
                        this.populateDocumentSelect('docSelectAnalysis');
                        break;
                    case 'questions':
                        document.getElementById('uploadQuestions')?.addEventListener('change', (e) => {
                            if (e.target.files[0]) {
                                this.uploadForAnalysis(e.target.files[0], 'smart_questions');
                            }
                        });
                        this.populateDocumentSelect('docSelectQuestions');
                        break;
                    case 'email':
                        document.getElementById('uploadEmail')?.addEventListener('change', (e) => {
                            if (e.target.files[0]) {
                                this.uploadForAnalysis(e.target.files[0], 'email_drafting');
                            }
                        });
                        this.populateDocumentSelect('docSelectEmail');
                        break;
                    case 'meeting':
                        document.getElementById('uploadMeeting')?.addEventListener('change', (e) => {
                            if (e.target.files[0]) {
                                this.uploadForAnalysis(e.target.files[0], 'meeting_processing');
                            }
                        });
                        break;
                }
            }

            toggleLiveRecording() {
                const btn = document.getElementById('liveRecordBtn');
                const status = document.getElementById('recordingStatus');
                
                if (this.voiceProcessor && this.voiceProcessor.isRecording) {
                    this.voiceProcessor.stopRecording();
                    btn.innerHTML = '<i class="fas fa-microphone me-2"></i>Start Recording';
                    btn.className = 'btn btn-success flex-fill';
                    status.style.background = '#6c757d';
                    status.style.animation = 'none';
                    
                    // Save the recording session
                    this.saveMeetingRecording();
                    this.addMeetingResult('Recording stopped', 'Live recording session ended and saved to meeting history');
                } else {
                    if (this.voiceProcessor) {
                        this.currentRecordingStart = new Date();
                        this.currentTranscript = '';
                        
                        this.voiceProcessor.startRecording().then(() => {
                            btn.innerHTML = '<i class="fas fa-stop me-2"></i>Stop Recording';
                            btn.className = 'btn btn-danger flex-fill';
                            status.style.background = '#dc3545';
                            status.style.animation = 'blink 1s infinite';
                            this.addMeetingResult('Recording started', 'Live meeting recording in progress...');
                            
                            // Listen for transcription updates
                            this.setupRecordingListener();
                        }).catch(error => {
                            this.showNotification('❌ Failed to start recording');
                        });
                    } else {
                        this.showNotification('⚠️ Voice processor not initialized');
                    }
                }
            }

            setupRecordingListener() {
                // Listen for voice transcription events
                const transcriptionHandler = (event) => {
                    if (event.detail && event.detail.text) {
                        this.currentTranscript += event.detail.text + ' ';
                        this.addMeetingResult('Transcription update', event.detail.text);
                    }
                };
                
                window.addEventListener('voiceTranscription', transcriptionHandler);
                
                // Store the handler so we can remove it later
                this.currentTranscriptionHandler = transcriptionHandler;
            }

            saveMeetingRecording() {
                if (this.currentRecordingStart && this.currentTranscript) {
                    const duration = Math.floor((new Date() - this.currentRecordingStart) / 1000);
                    const durationText = `${Math.floor(duration / 60)}:${duration % 60}`;
                    
                    const recording = {
                        id: Date.now().toString(),
                        type: 'live_recording',
                        title: `Live Meeting - ${new Date().toLocaleDateString()}`,
                        content: this.currentTranscript,
                        timestamp: this.currentRecordingStart.toISOString(),
                        duration: durationText
                    };
                    
                    // Save to meeting recordings
                    let recordings = JSON.parse(localStorage.getItem('meetingRecordings') || '[]');
                    recordings.unshift(recording);
                    recordings = recordings.slice(0, 20); // Keep last 20 recordings
                    localStorage.setItem('meetingRecordings', JSON.stringify(recordings));
                    
                    // Also add to main results history
                    this.addToResultsHistory('meeting', recording.title, `
                        <div class="meeting-transcript">
                            <div class="mb-3">
                                <h6>📹 Live Recording Details</h6>
                                <p><strong>Duration:</strong> ${durationText}</p>
                                <p><strong>Date:</strong> ${new Date(recording.timestamp).toLocaleString()}</p>
                            </div>
                            <div class="mb-3">
                                <h6>📝 Transcript</h6>
                                <div style="background: var(--surface-bg); padding: 16px; border-radius: 8px; border-left: 3px solid var(--primary-blue);">
                                    ${this.currentTranscript || 'No transcript available'}
                                </div>
                            </div>
                        </div>
                    `);
                    
                    // Clean up
                    if (this.currentTranscriptionHandler) {
                        window.removeEventListener('voiceTranscription', this.currentTranscriptionHandler);
                    }
                    this.currentTranscript = '';
                    this.currentRecordingStart = null;
                    
                    this.showNotification('✅ Meeting recording saved to history');
                }
            }

            addMeetingResult(title, content) {
                const resultsArea = document.getElementById('meetingResults');
                if (resultsArea) {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'alert alert-info mb-3';
                    resultDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${title}</h6>
                                <p class="mb-0">${content}</p>
                                <small class="text-muted">${new Date().toLocaleString()}</small>
                            </div>
                        </div>
                    `;
                    resultsArea.appendChild(resultDiv);
                }
            }

            addToResultsHistory(toolType, title, content) {
                try {
                    const result = {
                        id: Date.now().toString(),
                        type: toolType,
                        title: title,
                        content: content,
                        timestamp: new Date().toISOString()
                    };
                    
                    let history = JSON.parse(localStorage.getItem('analysisResults') || '[]');
                    history.unshift(result);
                    history = history.slice(0, 50); // Keep only last 50 results
                    localStorage.setItem('analysisResults', JSON.stringify(history));
                } catch (error) {
                    console.warn('Failed to save to results history:', error);
                }
            }

            loadResultsHistory() {
                try {
                    const resultsContent = document.getElementById('resultsContent');
                    const history = JSON.parse(localStorage.getItem('analysisResults') || '[]');
                    
                    if (history.length === 0) {
                        resultsContent.innerHTML = '<p style="color: var(--text-secondary);">No analysis results yet. Run some analyses to see your history here.</p>';
                        return;
                    }
                    
                    const groupedResults = {};
                    history.forEach(result => {
                        if (!groupedResults[result.type]) {
                            groupedResults[result.type] = [];
                        }
                        groupedResults[result.type].push(result);
                    });
                    
                    let historyHtml = '';
                    Object.keys(groupedResults).forEach(type => {
                        const typeIcon = this.getTypeIcon(type);
                        historyHtml += `
                            <div class="mb-4">
                                <h6 style="color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">
                                    <i class="${typeIcon} me-2"></i>${this.getTypeLabel(type)}
                                </h6>
                                <div class="ms-3">
                        `;
                        
                        groupedResults[type].slice(0, 5).forEach(result => {
                            historyHtml += `
                                <div class="result-item mb-2 p-2" style="background: var(--surface-bg); border-radius: 6px; border-left: 3px solid var(--primary-blue); cursor: pointer;" onclick="window.dashboard.showResult('${result.id}')">
                                    <div class="fw-bold small" style="color: var(--text-primary);">${result.title}</div>
                                    <div class="small text-muted">${new Date(result.timestamp).toLocaleString()}</div>
                                </div>
                            `;
                        });
                        
                        historyHtml += '</div></div>';
                    });
                    
                    resultsContent.innerHTML = historyHtml;
                } catch (error) {
                    console.warn('Failed to load results history:', error);
                    document.getElementById('resultsContent').innerHTML = '<p style="color: var(--text-secondary);">Failed to load history.</p>';
                }
            }

            getTypeIcon(type) {
                const icons = {
                    'analysis': 'fas fa-search',
                    'questions': 'fas fa-question-circle',
                    'email': 'fas fa-envelope',
                    'meeting': 'fas fa-microphone',
                    'blog': 'fas fa-edit'
                };
                return icons[type] || 'fas fa-file';
            }

            getTypeLabel(type) {
                const labels = {
                    'analysis': 'Document Analysis',
                    'questions': 'Smart Questions',
                    'email': 'Email Drafts',
                    'meeting': 'Meeting Processing',
                    'blog': 'Content Generation'
                };
                return labels[type] || type;
            }

            showResult(resultId) {
                try {
                    const history = JSON.parse(localStorage.getItem('analysisResults') || '[]');
                    const result = history.find(r => r.id === resultId);
                    
                    if (result) {
                        const workArea = document.getElementById('activeWorkArea');
                        workArea.innerHTML = `
                            <div class="result-viewer">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div class="d-flex align-items-center">
                                        <i class="${this.getTypeIcon(result.type)} me-3" style="font-size: 2rem; color: var(--primary-blue);"></i>
                                        <div>
                                            <h4 style="color: var(--text-primary); margin: 0;">${result.title}</h4>
                                            <p style="color: var(--text-secondary); margin: 0;">${new Date(result.timestamp).toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <button class="btn btn-outline-secondary" onclick="window.dashboard.clearWorkspace()">
                                        <i class="fas fa-times me-2"></i>Close
                                    </button>
                                </div>
                                <div class="result-content" style="background: var(--surface-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                                    ${result.content}
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.warn('Failed to show result:', error);
                }
            }

            viewDocumentLibrary() {
                const workArea = document.getElementById('activeWorkArea');
                workArea.innerHTML = `
                    <div class="library-view">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-folder me-3" style="font-size: 2rem; color: var(--primary-blue);"></i>
                                <div>
                                    <h4 style="color: var(--text-primary); margin: 0;">Document Library</h4>
                                    <p style="color: var(--text-secondary); margin: 0;">Manage and analyze your uploaded documents</p>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <input type="file" id="libraryUpload" class="form-control" style="background: var(--surface-bg); border: 1px solid var(--border-color); color: var(--text-primary); max-width: 300px;" accept=".pdf,.docx,.txt" multiple>
                                <button class="btn btn-outline-secondary" onclick="window.dashboard.clearWorkspace()">
                                    <i class="fas fa-times me-2"></i>Close
                                </button>
                            </div>
                        </div>
                        <div id="documentLibraryContent" class="library-content">
                            <div class="text-center py-4">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-blue);"></i>
                                <p style="color: var(--text-secondary); margin-top: 16px;">Loading document library...</p>
                            </div>
                        </div>
                    </div>
                `;
                
                this.loadDocumentLibrary();
                
                // Setup file upload for library
                document.getElementById('libraryUpload')?.addEventListener('change', (e) => {
                    Array.from(e.target.files).forEach(file => {
                        this.uploadForAnalysis(file, 'document_analysis');
                    });
                });
            }

            loadDocumentLibrary() {
                // Fetch documents from server and localStorage
                const libraryContent = document.getElementById('documentLibraryContent');
                
                // For now, show documents from analysis history
                const history = JSON.parse(localStorage.getItem('analysisResults') || '[]');
                const documents = history.filter(result => result.type === 'analysis');
                
                if (documents.length === 0) {
                    libraryContent.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-folder-open" style="font-size: 3rem; color: var(--text-muted);"></i>
                            <h5 style="color: var(--text-primary); margin-top: 16px;">No documents yet</h5>
                            <p style="color: var(--text-secondary);">Upload documents using the file input above or from the Analysis tool.</p>
                        </div>
                    `;
                    return;
                }
                
                let libraryHtml = '<div class="row">';
                documents.forEach(doc => {
                    const fileType = this.getFileTypeFromTitle(doc.title);
                    const icon = this.getFileIcon(fileType);
                    
                    libraryHtml += `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="document-card" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s ease;" onclick="window.dashboard.showResult('${doc.id}')">
                                <div class="d-flex align-items-start">
                                    <i class="${icon} me-3" style="font-size: 2rem; color: var(--primary-blue);"></i>
                                    <div class="flex-grow-1">
                                        <h6 style="color: var(--text-primary); margin: 0; font-weight: 600;">${doc.title}</h6>
                                        <p style="color: var(--text-secondary); margin: 4px 0; font-size: 0.9rem;">${new Date(doc.timestamp).toLocaleDateString()}</p>
                                        <div class="d-flex gap-1 mt-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); window.dashboard.analyzeDocument('${doc.id}')">
                                                <i class="fas fa-search me-1"></i>Re-analyze
                                            </button>
                                            <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); window.dashboard.generateQuestionsFromDoc('${doc.id}')">
                                                <i class="fas fa-question me-1"></i>Questions
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                libraryHtml += '</div>';
                
                libraryContent.innerHTML = libraryHtml;
            }

            getFileTypeFromTitle(title) {
                if (title.includes('.pdf')) return 'pdf';
                if (title.includes('.docx') || title.includes('.doc')) return 'word';
                if (title.includes('.txt')) return 'text';
                return 'document';
            }

            getFileIcon(fileType) {
                const icons = {
                    'pdf': 'fas fa-file-pdf',
                    'word': 'fas fa-file-word',
                    'text': 'fas fa-file-alt',
                    'document': 'fas fa-file'
                };
                return icons[fileType] || 'fas fa-file';
            }

            viewMeetingHistory() {
                const workArea = document.getElementById('activeWorkArea');
                workArea.innerHTML = `
                    <div class="meeting-history-view">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-history me-3" style="font-size: 2rem; color: var(--primary-blue);"></i>
                                <div>
                                    <h4 style="color: var(--text-primary); margin: 0;">Meeting History</h4>
                                    <p style="color: var(--text-secondary); margin: 0;">Review past meetings and transcripts</p>
                                </div>
                            </div>
                            <button class="btn btn-outline-secondary" onclick="window.dashboard.clearWorkspace()">
                                <i class="fas fa-times me-2"></i>Close
                            </button>
                        </div>
                        <div id="meetingHistoryContent" class="meeting-content">
                            <div class="text-center py-4">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-blue);"></i>
                                <p style="color: var(--text-secondary); margin-top: 16px;">Loading meeting history...</p>
                            </div>
                        </div>
                    </div>
                `;
                
                this.loadMeetingHistory();
            }

            loadMeetingHistory() {
                const historyContent = document.getElementById('meetingHistoryContent');
                
                // Get meeting results from localStorage
                const history = JSON.parse(localStorage.getItem('analysisResults') || '[]');
                const meetings = history.filter(result => result.type === 'meeting');
                
                // Also get voice recordings from localStorage
                const voiceHistory = JSON.parse(localStorage.getItem('meetingRecordings') || '[]');
                
                const allMeetings = [...meetings, ...voiceHistory].sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                
                if (allMeetings.length === 0) {
                    historyContent.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-microphone-slash" style="font-size: 3rem; color: var(--text-muted);"></i>
                            <h5 style="color: var(--text-primary); margin-top: 16px;">No meetings recorded</h5>
                            <p style="color: var(--text-secondary);">Start recording meetings or upload transcripts to see your history here.</p>
                        </div>
                    `;
                    return;
                }
                
                let historyHtml = '';
                allMeetings.forEach(meeting => {
                    const isLiveRecording = meeting.type === 'live_recording';
                    const icon = isLiveRecording ? 'fas fa-microphone' : 'fas fa-file-alt';
                    const badgeColor = isLiveRecording ? 'success' : 'primary';
                    const badgeText = isLiveRecording ? 'Live Recording' : 'Transcript Analysis';
                    
                    historyHtml += `
                        <div class="meeting-item mb-3 p-3" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;" onclick="window.dashboard.showMeetingDetails('${meeting.id}')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-start">
                                    <i class="${icon} me-3" style="font-size: 1.5rem; color: var(--primary-blue);"></i>
                                    <div>
                                        <h6 style="color: var(--text-primary); margin: 0;">${meeting.title}</h6>
                                        <p style="color: var(--text-secondary); margin: 4px 0; font-size: 0.9rem;">${new Date(meeting.timestamp).toLocaleString()}</p>
                                        ${meeting.duration ? `<small style="color: var(--text-muted);">Duration: ${meeting.duration}</small>` : ''}
                                    </div>
                                </div>
                                <span class="badge bg-${badgeColor}">${badgeText}</span>
                            </div>
                        </div>
                    `;
                });
                
                historyContent.innerHTML = historyHtml;
            }

            showMeetingDetails(meetingId) {
                const history = JSON.parse(localStorage.getItem('analysisResults') || '[]');
                const voiceHistory = JSON.parse(localStorage.getItem('meetingRecordings') || '[]');
                const meeting = [...history, ...voiceHistory].find(m => m.id === meetingId);
                
                if (meeting) {
                    this.showResult(meetingId);
                }
            }

            clearWorkspace() {
                const workArea = document.getElementById('activeWorkArea');
                workArea.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-rocket" style="font-size: 3rem; color: var(--primary-blue); margin-bottom: 16px;"></i>
                        <h5 style="color: var(--text-primary);">Welcome to Your AI Workspace</h5>
                        <p style="color: var(--text-secondary);">Select a tool above to get started with document analysis, meeting processing, or content generation.</p>
                    </div>
                `;
            }

            setupWebSockets() {
                // Real-time updates for collaboration
                if (typeof WebSocket !== 'undefined') {
                    try {
                        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                        const wsUrl = `${wsProtocol}//${window.location.host}/ws/dashboard`;
                        this.ws = new WebSocket(wsUrl);
                        
                        this.ws.onopen = () => {
                            console.log('✅ WebSocket connected');
                        };
                        
                        this.ws.onmessage = (event) => {
                            const data = JSON.parse(event.data);
                            this.handleRealtimeUpdate(data);
                        };
                        
                        this.ws.onerror = (error) => {
                            console.log('🔴 WebSocket error, falling back to polling');
                            this.startPollingFallback();
                        };
                        
                        this.ws.onclose = () => {
                            console.log('📴 WebSocket disconnected, using polling mode');
                            this.startPollingFallback();
                        };
                    } catch (error) {
                        console.log('WebSocket not available, using polling');
                        this.startPollingFallback();
                    }
                } else {
                    this.startPollingFallback();
                }
            }

            startPollingFallback() {
                if (!this.pollingActive) {
                    this.pollingActive = true;
                    setInterval(() => this.pollForUpdates(), 30000);
                }
            }

            pollForUpdates() {
                // Poll for updates when WebSocket is not available
                try {
                    this.updateContextualData();
                    this.loadSmartRecommendations();
                } catch (error) {
                    console.warn('Polling update failed:', error.message);
                }
            }

            setupEventListeners() {
                // Command input
                document.getElementById('commandInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.processCommand(e.target.value);
                        e.target.value = '';
                    }
                });
            }

            updateTime() {
                const now = new Date();
                document.getElementById('currentTime').textContent = 
                    now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            }

            async processCommand(command) {
                console.log('Processing command:', command);
                this.addNotification(`Processing command: "${command}"`, 'info', 'Command Processing');
                this.addProgressItem(`Processing command: ${command}`, 'processing');
                
                try {
                    // Send command to real AI processing endpoint
                    const response = await fetch('/process-text', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: command,
                            action: 'smart_questions',
                            user_id: 'Paresh'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        
                        // Display result in workspace
                        const resultArea = document.querySelector('#activeDocument');
                        if (resultArea) {
                            resultArea.innerHTML = `
                                <div class="mb-3">
                                    <h6 class="text-info">🤖 AI Response</h6>
                                    <div class="p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                                        <p class="text-white mb-2"><strong>Command:</strong> ${command}</p>
                                        <div class="text-white">${result.result || result.analysis || 'Command processed successfully'}</div>
                                        <small class="text-muted d-block mt-2">${new Date().toLocaleString()}</small>
                                    </div>
                                </div>
                            ` + resultArea.innerHTML;
                        }
                        
                        this.addNotification('Command executed successfully', 'success', 'Command Complete');
                        this.addProgressItem(`Command completed: ${command}`, 'completed');
                        
                        // Refresh data to show updated results
                        this.loadRealDocuments();
                        this.loadRealInsights();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error('Command processing error:', error);
                    this.addNotification('Command processing failed', 'error', 'Command Error');
                    this.addProgressItem(`Command failed: ${command}`, 'error');
                }
            }


            async showCollaborationInterface() {
                this.addNotification('Loading Collaboration Intelligence...', 'info', 'Collaboration');
                
                // Get the main workspace area
                const workArea = document.querySelector('#activeWorkArea');
                if (!workArea) return;
                
                try {
                    // Load collaboration data from API
                    const [platformStatus, suggestions, recentMessages, analytics] = await Promise.all([
                        fetch('http://localhost:8001/platforms/status').then(r => r.ok ? r.json() : null).catch(() => null),
                        fetch('http://localhost:8001/suggestions/pending').then(r => r.ok ? r.json() : null).catch(() => null),
                        fetch('http://localhost:8001/messages/recent?limit=10').then(r => r.ok ? r.json() : null).catch(() => null),
                        fetch('http://localhost:8001/analytics/summary').then(r => r.ok ? r.json() : null).catch(() => null)
                    ]);

                    workArea.innerHTML = `
                        <div class="collaboration-intelligence-workspace">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="text-white mb-0">
                                    <i class="fas fa-users-cog me-2 text-success"></i>
                                    Collaboration Intelligence
                                </h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-light btn-sm" onclick="window.dashboard.refreshCollaboration()">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="window.dashboard.configureCollaboration()">
                                        <i class="fas fa-cog me-1"></i>Configure
                                    </button>
                                </div>
                            </div>

                            <!-- Platform Status -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="glass-card p-3">
                                        <h6 class="text-white mb-3">
                                            <i class="fab fa-slack me-2 text-info"></i>Slack Status
                                        </h6>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="status-indicator ${platformStatus?.slack?.connected ? 'bg-success' : 'bg-danger'} me-2"></div>
                                            <span class="text-white">${platformStatus?.slack?.connected ? 'Connected' : 'Disconnected'}</span>
                                        </div>
                                        <div class="small text-muted">
                                            <div>Channels: ${platformStatus?.slack?.channels?.length || 0}</div>
                                            <div>Rate Limit: ${platformStatus?.slack?.rate_limit_remaining || 'N/A'}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="glass-card p-3">
                                        <h6 class="text-white mb-3">
                                            <i class="fab fa-microsoft me-2 text-primary"></i>Teams Status
                                        </h6>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="status-indicator ${platformStatus?.teams?.connected ? 'bg-success' : 'bg-danger'} me-2"></div>
                                            <span class="text-white">${platformStatus?.teams?.connected ? 'Connected' : 'Disconnected'}</span>
                                        </div>
                                        <div class="small text-muted">
                                            <div>Channels: ${platformStatus?.teams?.channels?.length || 0}</div>
                                            <div>Rate Limit: ${platformStatus?.teams?.rate_limit_remaining || 'N/A'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Smart Suggestions -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="glass-card p-3">
                                        <h6 class="text-white mb-3">
                                            <i class="fas fa-lightbulb me-2 text-warning"></i>
                                            Smart Suggestions (${suggestions?.count || 0})
                                        </h6>
                                        <div id="collaborationSuggestions">
                                            ${suggestions?.suggestions ? this.renderCollaborationSuggestions(suggestions.suggestions) : '<div class="text-muted">No suggestions available</div>'}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Messages & Analytics -->
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="glass-card p-3">
                                        <h6 class="text-white mb-3">
                                            <i class="fas fa-comments me-2 text-info"></i>Recent Messages
                                        </h6>
                                        <div id="recentMessages" style="max-height: 300px; overflow-y: auto;">
                                            ${recentMessages?.messages ? this.renderRecentMessages(recentMessages.messages) : '<div class="text-muted">No recent messages</div>'}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="glass-card p-3">
                                        <h6 class="text-white mb-3">
                                            <i class="fas fa-chart-pie me-2 text-success"></i>Analytics
                                        </h6>
                                        <div id="collaborationAnalytics">
                                            ${analytics ? this.renderCollaborationAnalytics(analytics) : '<div class="text-muted">No analytics available</div>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    this.addNotification('Collaboration Intelligence loaded', 'success', 'Collaboration');
                } catch (error) {
                    console.error('Failed to load collaboration interface:', error);
                    workArea.innerHTML = `
                        <div class="text-center p-5">
                            <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                            <h5 class="text-white mt-3">Collaboration Service Unavailable</h5>
                            <p class="text-muted">Unable to connect to collaboration intelligence API</p>
                            <button class="btn btn-primary" onclick="window.dashboard.showCollaborationInterface()">
                                <i class="fas fa-retry me-1"></i>Retry
                            </button>
                        </div>
                    `;
                    this.showNotification('❌ Failed to load collaboration interface');
                }
            }

            renderCollaborationSuggestions(suggestions) {
                if (!suggestions || suggestions.length === 0) {
                    return '<div class="text-muted">No suggestions available</div>';
                }
                
                return suggestions.slice(0, 5).map(suggestion => `
                    <div class="suggestion-item mb-3 p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px; border-left: 3px solid #38ef7d;">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0 text-white">${suggestion.title}</h6>
                            <span class="badge bg-${suggestion.confidence > 0.8 ? 'success' : suggestion.confidence > 0.6 ? 'warning' : 'secondary'}">
                                ${Math.round(suggestion.confidence * 100)}%
                            </span>
                        </div>
                        <p class="small text-muted mb-2">${suggestion.description}</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm" onclick="window.dashboard.executeSuggestion('${suggestion.id}', true)">
                                <i class="fas fa-check me-1"></i>Execute
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="window.dashboard.executeSuggestion('${suggestion.id}', false)">
                                <i class="fas fa-times me-1"></i>Dismiss
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderRecentMessages(messages) {
                if (!messages || messages.length === 0) {
                    return '<div class="text-muted">No recent messages</div>';
                }
                
                return messages.map(msg => {
                    const message = msg.message;
                    const analysis = msg.analysis;
                    return `
                        <div class="message-item mb-3 p-3" style="background: rgba(255,255,255,0.05); border-radius: 10px;">
                            <div class="d-flex justify-content-between mb-2">
                                <div class="d-flex align-items-center">
                                    <i class="fab fa-${message.platform} me-2 text-${message.platform === 'slack' ? 'info' : 'primary'}"></i>
                                    <strong class="text-white">${message.user}</strong>
                                    <span class="text-muted ms-2">${message.channel}</span>
                                </div>
                                <small class="text-muted">${new Date(message.timestamp).toLocaleTimeString()}</small>
                            </div>
                            <p class="text-white small mb-2">${message.text}</p>
                            ${analysis ? `
                                <div class="analysis-tags">
                                    ${analysis.action_items?.length > 0 ? `<span class="badge bg-warning me-1">${analysis.action_items.length} Actions</span>` : ''}
                                    ${analysis.questions?.length > 0 ? `<span class="badge bg-info me-1">${analysis.questions.length} Questions</span>` : ''}
                                    ${analysis.priority_score > 7 ? `<span class="badge bg-danger me-1">High Priority</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            renderCollaborationAnalytics(analytics) {
                if (!analytics || !analytics.summary) {
                    return '<div class="text-muted">No analytics available</div>';
                }
                
                const summary = analytics.summary;
                return `
                    <div class="analytics-summary">
                        <div class="metric-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Messages</span>
                                <strong class="text-white">${summary.total_messages || 0}</strong>
                            </div>
                        </div>
                        <div class="metric-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Action Items</span>
                                <strong class="text-warning">${summary.action_items_identified || 0}</strong>
                            </div>
                        </div>
                        <div class="metric-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Questions</span>
                                <strong class="text-info">${summary.questions_raised || 0}</strong>
                            </div>
                        </div>
                        <div class="metric-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Suggestions</span>
                                <strong class="text-success">${summary.suggestions_generated || 0}</strong>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Executed</span>
                                <strong class="text-primary">${summary.actions_executed || 0}</strong>
                            </div>
                        </div>
                    </div>
                `;
            }

            async executeSuggestion(suggestionId, approved) {
                try {
                    const response = await fetch(`http://localhost:8001/suggestions/${suggestionId}/execute`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action_id: suggestionId, approved: approved })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.showNotification(approved ? `✅ Action executed: ${result.action.title}` : `❌ Action dismissed`);
                        // Refresh suggestions
                        this.showCollaborationInterface();
                    } else {
                        this.showNotification('❌ Failed to execute action');
                    }
                } catch (error) {
                    console.error('Failed to execute suggestion:', error);
                    this.showNotification('❌ Error executing action');
                }
            }

            async refreshCollaboration() {
                this.showNotification('🔄 Refreshing collaboration data...');
                await this.showCollaborationInterface();
            }

            configureCollaboration() {
                this.showNotification('⚙️ Configuration panel coming soon');
                // TODO: Implement configuration interface
            }

            showAnalyticsInterface() {
                this.showNotification('📊 Analytics interface coming soon');
                // TODO: Implement analytics interface
            }

            showMemoryInterface() {
                this.showNotification('🧠 Memory interface coming soon');
                // TODO: Implement memory interface
            }

            showSettingsInterface() {
                this.showNotification('⚙️ Settings interface coming soon');
                // TODO: Implement settings interface
            }

            showNotification(message) {
                // Add to notification panel instead of showing popup
                this.addNotification(message, 'info');
                this.addProgressItem(message, 'info');
            }

            // New notification system methods
            addNotification(message, type = 'info', title = null) {
                const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                const notification = {
                    id: Date.now().toString(),
                    title: title || 'System Notification',
                    message: message,
                    type: type,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                notifications.unshift(notification);
                
                // Keep only last 50 notifications
                if (notifications.length > 50) {
                    notifications.splice(50);
                }
                
                localStorage.setItem('notifications', JSON.stringify(notifications));
                this.updateNotificationBadge();
                this.refreshNotificationPanel();
            }

            toggleNotificationPanel() {
                const panel = document.getElementById('notificationPanel');
                const isVisible = panel.style.display === 'block';
                
                if (isVisible) {
                    panel.style.display = 'none';
                } else {
                    panel.style.display = 'block';
                    this.refreshNotificationPanel();
                    this.markNotificationsAsRead();
                }
            }

            refreshNotificationPanel() {
                const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                const listElement = document.getElementById('notificationList');
                
                if (notifications.length === 0) {
                    listElement.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-bell-slash" style="color: var(--text-muted); font-size: 2rem;"></i>
                            <p style="color: var(--text-muted); margin-top: 12px;">No notifications yet</p>
                        </div>
                    `;
                    return;
                }
                
                listElement.innerHTML = notifications.map(notification => {
                    const timeAgo = this.getTimeAgo(new Date(notification.timestamp));
                    const iconClass = this.getNotificationIcon(notification.type);
                    
                    return `
                        <div class="notification-item ${!notification.read ? 'unread' : ''}">
                            <div class="notification-icon ${notification.type}">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">${notification.title}</div>
                                <div class="notification-text">${notification.message}</div>
                                <div class="notification-time">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            markNotificationsAsRead() {
                const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                notifications.forEach(n => n.read = true);
                localStorage.setItem('notifications', JSON.stringify(notifications));
                this.updateNotificationBadge();
            }

            updateNotificationBadge() {
                const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                const unreadCount = notifications.filter(n => !n.read).length;
                const badge = document.getElementById('notificationBadge');
                
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.style.display = 'block';
                    
                    // Add animation to bell
                    const bell = document.getElementById('notificationBell');
                    bell.style.animation = 'bounce 0.5s ease';
                    setTimeout(() => { bell.style.animation = 'none'; }, 500);
                } else {
                    badge.style.display = 'none';
                }
            }

            clearAllNotifications() {
                localStorage.removeItem('notifications');
                this.refreshNotificationPanel();
                this.updateNotificationBadge();
                this.addNotification('All notifications cleared', 'success', 'System');
            }

            getNotificationIcon(type) {
                const icons = {
                    'info': 'fa-info-circle',
                    'success': 'fa-check-circle',
                    'warning': 'fa-exclamation-triangle',
                    'error': 'fa-times-circle'
                };
                return icons[type] || 'fa-info-circle';
            }

            getTimeAgo(date) {
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / (1000 * 60));
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                return `${days}d ago`;
            }

            // Progress Console Methods
            addProgressItem(message, status = 'processing', details = null) {
                const progressItems = JSON.parse(localStorage.getItem('progressItems') || '[]');
                const item = {
                    id: Date.now().toString(),
                    message: message,
                    status: status, // 'processing', 'completed', 'error'
                    details: details,
                    timestamp: new Date().toISOString()
                };
                
                progressItems.unshift(item);
                
                // Keep only last 20 items
                if (progressItems.length > 20) {
                    progressItems.splice(20);
                }
                
                localStorage.setItem('progressItems', JSON.stringify(progressItems));
                this.showProgressConsole();
                this.refreshProgressConsole();
                
                // Auto-hide if completed or error after 5 seconds
                if (status === 'completed' || status === 'error') {
                    setTimeout(() => {
                        this.updateProgressItemStatus(item.id, status);
                    }, 5000);
                }
            }

            updateProgressItemStatus(itemId, newStatus) {
                const progressItems = JSON.parse(localStorage.getItem('progressItems') || '[]');
                const item = progressItems.find(p => p.id === itemId);
                if (item) {
                    item.status = newStatus;
                    localStorage.setItem('progressItems', JSON.stringify(progressItems));
                    this.refreshProgressConsole();
                }
            }

            showProgressConsole() {
                const console = document.getElementById('progressConsole');
                console.style.display = 'block';
            }

            toggleProgressConsole() {
                const console = document.getElementById('progressConsole');
                const isVisible = console.style.display === 'block';
                console.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    this.refreshProgressConsole();
                }
            }

            refreshProgressConsole() {
                const progressItems = JSON.parse(localStorage.getItem('progressItems') || '[]');
                const contentElement = document.getElementById('consoleContent');
                
                if (progressItems.length === 0) {
                    contentElement.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-list-ul" style="color: var(--text-muted); font-size: 1.5rem;"></i>
                            <p style="color: var(--text-muted); margin-top: 8px; font-size: 14px;">Activity will appear here</p>
                        </div>
                    `;
                    return;
                }
                
                contentElement.innerHTML = progressItems.map(item => {
                    const timeAgo = this.getTimeAgo(new Date(item.timestamp));
                    
                    return `
                        <div class="console-item">
                            <div class="console-icon ${item.status}">
                                <i class="fas ${this.getProgressIcon(item.status)}"></i>
                            </div>
                            <div class="console-text">${item.message}</div>
                            <div class="console-time">${timeAgo}</div>
                        </div>
                    `;
                }).join('');
            }

            clearProgressConsole() {
                localStorage.removeItem('progressItems');
                this.refreshProgressConsole();
                this.addProgressItem('Console cleared', 'completed');
            }

            getProgressIcon(status) {
                const icons = {
                    'processing': 'fa-spinner fa-spin',
                    'completed': 'fa-check',
                    'error': 'fa-times'
                };
                return icons[status] || 'fa-circle';
            }

            // Display methods for enhanced results
            displayComprehensiveAnalysis(content, filename, container) {
                let formattedContent = content;
                
                if (typeof content === 'object') {
                    formattedContent = this.formatAnalysisObject(content);
                } else if (typeof content === 'string') {
                    formattedContent = this.formatAnalysisText(content);
                }
                
                container.innerHTML = `
                    <div class="comprehensive-analysis-result">
                        <div class="analysis-header mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 style="color: var(--success-color); margin: 0;">
                                    <i class="fas fa-check-circle me-2"></i>Comprehensive Analysis Complete
                                </h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="window.dashboard.copyToClipboard('analysisContent')">
                                        <i class="fas fa-copy me-1"></i>Copy
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" onclick="window.dashboard.exportAnalysis('${filename}')">
                                        <i class="fas fa-download me-1"></i>Export
                                    </button>
                                </div>
                            </div>
                            <p style="color: var(--text-secondary); margin: 8px 0 0 0;">Document: ${filename}</p>
                        </div>
                        
                        <div id="analysisContent" class="analysis-content" style="background: var(--surface-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px;">
                            ${formattedContent}
                        </div>
                    </div>
                `;
            }

            displaySmartQuestions(questions, filename, container) {
                let questionsHtml = '';
                
                if (typeof questions === 'string') {
                    questionsHtml = questions;
                } else if (Array.isArray(questions)) {
                    questionsHtml = questions.map((q, i) => `<div class="question-item mb-3"><strong>Q${i+1}:</strong> ${q}</div>`).join('');
                } else if (typeof questions === 'object') {
                    questionsHtml = this.formatObjectAsHTML(questions);
                }
                
                container.innerHTML = `
                    <div class="smart-questions-result">
                        <div class="questions-header mb-4">
                            <h5 style="color: var(--success-color); margin: 0;">
                                <i class="fas fa-check-circle me-2"></i>Smart Questions Generated
                            </h5>
                            <p style="color: var(--text-secondary); margin: 8px 0 0 0;">From: ${filename}</p>
                        </div>
                        
                        <div class="questions-content" style="background: var(--surface-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px;">
                            ${questionsHtml}
                        </div>
                    </div>
                `;
            }

            displayBlogContent(content, postType, container) {
                let blogHtml = content;
                
                if (typeof content === 'object') {
                    blogHtml = this.formatObjectAsHTML(content);
                }
                
                container.innerHTML = `
                    <div class="blog-content-result">
                        <div class="blog-header mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 style="color: var(--success-color); margin: 0;">
                                    <i class="fas fa-check-circle me-2"></i>${postType.charAt(0).toUpperCase() + postType.slice(1)} Generated
                                </h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="window.dashboard.copyToClipboard('blogContent')">
                                        <i class="fas fa-copy me-1"></i>Copy
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" onclick="window.dashboard.downloadBlog()">
                                        <i class="fas fa-download me-1"></i>Download
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="blogContent" class="blog-content" style="background: var(--surface-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; line-height: 1.7;">
                            ${blogHtml}
                        </div>
                    </div>
                `;
            }

            formatAnalysisObject(obj) {
                let html = '';
                
                // Handle comprehensive analysis object with multiple sections
                if (obj.executive_summary) {
                    html += `
                        <div class="analysis-section mb-4">
                            <h4 style="color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); padding-bottom: 8px;">Executive Summary</h4>
                            <div style="line-height: 1.7; margin-top: 16px;">${obj.executive_summary}</div>
                        </div>
                    `;
                }
                
                if (obj.key_findings || obj.key_points) {
                    const findings = obj.key_findings || obj.key_points;
                    html += `
                        <div class="analysis-section mb-4">
                            <h4 style="color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); padding-bottom: 8px;">Key Findings</h4>
                            <div style="line-height: 1.7; margin-top: 16px;">${Array.isArray(findings) ? '<ul>' + findings.map(f => `<li>${f}</li>`).join('') + '</ul>' : findings}</div>
                        </div>
                    `;
                }
                
                if (obj.detailed_analysis || obj.analysis) {
                    const analysis = obj.detailed_analysis || obj.analysis;
                    html += `
                        <div class="analysis-section mb-4">
                            <h4 style="color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); padding-bottom: 8px;">Detailed Analysis</h4>
                            <div style="line-height: 1.7; margin-top: 16px;">${analysis}</div>
                        </div>
                    `;
                }
                
                if (obj.recommendations) {
                    html += `
                        <div class="analysis-section mb-4">
                            <h4 style="color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); padding-bottom: 8px;">Recommendations</h4>
                            <div style="line-height: 1.7; margin-top: 16px;">${Array.isArray(obj.recommendations) ? '<ul>' + obj.recommendations.map(r => `<li>${r}</li>`).join('') + '</ul>' : obj.recommendations}</div>
                        </div>
                    `;
                }
                
                // If no structured sections, use the enhanced object formatter
                if (!html) {
                    html = this.formatObjectAsHTML(obj);
                }
                
                return html;
            }
            
            formatAnalysisText(text) {
                // Enhanced text formatting for comprehensive analysis
                if (typeof text !== 'string') {
                    return String(text);
                }
                
                // Convert text to HTML with proper formatting
                let formattedText = text
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');
                
                return `<div style="line-height: 1.8; font-size: 15px; color: var(--text-primary);"><p>${formattedText}</p></div>`;
            }

            startContextualUpdates() {
                // Simulate real-time updates
                setInterval(() => {
                    this.updateContextualData();
                }, 5000);
            }

            updateContextualData() {
                // Update productivity score safely
                try {
                    const progressBar = document.querySelector('.progress-bar');
                    if (progressBar) {
                        const newScore = Math.floor(Math.random() * 20) + 75;
                        progressBar.style.width = newScore + '%';
                        const scoreText = progressBar.nextElementSibling;
                        if (scoreText) {
                            scoreText.textContent = newScore + '%';
                        }
                    }
                } catch (error) {
                    console.warn('Progress bar update failed:', error);
                }
            }

            // Workspace management methods
            clearWorkspace() {
                const workArea = document.getElementById('activeWorkArea');
                if (workArea) {
                    workArea.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-rocket" style="font-size: 4rem; color: var(--primary-blue); margin-bottom: 24px;"></i>
                            <h3 style="color: var(--text-primary); margin-bottom: 16px;">Welcome to Your AI Workspace</h3>
                            <p style="color: var(--text-secondary); font-size: 1.1rem; max-width: 600px; margin: 0 auto;">Select a tool above to get started with document analysis, meeting processing, or content generation. Your AI-powered workspace is ready for any task.</p>
                        </div>
                    `;
                }
                
                // Hide results panel
                const resultsPanel = document.getElementById('resultsPanel');
                if (resultsPanel) {
                    resultsPanel.style.display = 'none';
                }
                
                this.addNotification('Workspace cleared', 'info', 'Workspace');
            }

            // Method to manually check for task completion
            async checkTaskStatus(taskId) {
                try {
                    const response = await fetch(`/task/${taskId}`);
                    if (response.ok) {
                        const task = await response.json();
                        console.log(`Manual check - Task ${taskId}:`, task);
                        return task;
                    } else {
                        console.log(`Task ${taskId} not found (${response.status})`);
                        return null;
                    }
                } catch (error) {
                    console.error('Error checking task status:', error);
                    return null;
                }
            }

            // Method to manually refresh and check for completed analysis
            async refreshAnalysisResults() {
                try {
                    this.addNotification('Checking for completed analysis...', 'info', 'Status Check');
                    
                    // Check for recent tasks and their results
                    const recentTasks = JSON.parse(localStorage.getItem('recentTaskIds') || '[]');
                    console.log('Checking recent tasks:', recentTasks);
                    
                    for (const taskData of recentTasks) {
                        const task = await this.checkTaskStatus(taskData.taskId);
                        if (task && task.status === 'completed' && task.result) {
                            console.log('Found completed task with results:', task);
                            this.displayTaskResult(taskData.taskId, task.result, taskData.filename);
                            this.addNotification(`Found completed analysis: ${taskData.filename}`, 'success', 'Analysis Found');
                            return; // Show the first completed task found
                        } else if (task && task.status === 'failed') {
                            this.addNotification(`Task failed: ${taskData.filename}`, 'error', 'Task Failed');
                        }
                    }
                    
                    // If no completed tasks found
                    this.addNotification('No completed analysis found', 'info', 'Status Check');
                } catch (error) {
                    console.error('Error refreshing analysis results:', error);
                    this.addNotification('Error checking analysis status', 'error', 'Status Check');
                }
            }

            // Enhanced analysis methods for comprehensive output
            async runDocumentAnalysis() {
                const docSelect = document.getElementById('docSelectAnalysis');
                const fileInput = document.getElementById('uploadAnalysis');
                const resultsDiv = document.getElementById('analysisResults');
                
                let selectedDoc = docSelect.value;
                let file = fileInput.files[0];
                
                if (!selectedDoc && !file) {
                    resultsDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Please select a document or upload a file.</div>';
                    return;
                }
                
                this.addNotification('Starting comprehensive document analysis...', 'info', 'Analysis');
                this.addProgressItem('Document analysis in progress', 'processing');
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3"></div>
                            <span>Running comprehensive analysis... This may take a few moments.</span>
                        </div>
                        <div class="mt-2">
                            <small>Analyzing content, extracting insights, generating summaries...</small>
                        </div>
                    </div>
                `;
                
                try {
                    let response;
                    let filename = '';
                    
                    if (file) {
                        filename = file.name;
                        // Upload new file for comprehensive analysis
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('action', 'comprehensive_analysis');
                        formData.append('analysis_type', 'full');
                        response = await fetch('/upload', {
                            method: 'POST',
                            body: formData
                        });
                    } else {
                        // Analyze existing document with comprehensive analysis
                        response = await fetch('/process-text', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                document_id: selectedDoc, 
                                action: 'comprehensive_analysis',
                                analysis_type: 'full',
                                include_summary: true,
                                include_insights: true,
                                include_key_points: true
                            })
                        });
                        filename = 'Selected Document';
                    }
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Analysis response:', result);
                        
                        if (result.task_id) {
                            // Monitor task and display results when complete
                            this.monitorTask(result.task_id, filename);
                        } else if (result.result || result.analysis) {
                            // Direct result - format comprehensively
                            const analysisContent = result.result || result.analysis;
                            this.displayComprehensiveAnalysis(analysisContent, filename, resultsDiv);
                            this.addNotification('Document analysis completed', 'success', 'Analysis');
                            this.addProgressItem('Document analysis completed', 'completed');
                        }
                    } else {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                } catch (error) {
                    console.error('Analysis error:', error);
                    this.addNotification('Document analysis failed', 'error', 'Analysis');
                    this.addProgressItem('Document analysis failed', 'error');
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Analysis failed: ${error.message}. Please try again.
                        </div>
                    `;
                }
            }

            async generateSmartQuestions() {
                const docSelect = document.getElementById('docSelectQuestions');
                const fileInput = document.getElementById('uploadQuestions');
                const resultsDiv = document.getElementById('questionsResults');
                
                let selectedDoc = docSelect.value;
                let file = fileInput.files[0];
                
                if (!selectedDoc && !file) {
                    resultsDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Please select a document or upload a file.</div>';
                    return;
                }
                
                this.addNotification('Generating smart questions...', 'info', 'Questions');
                this.addProgressItem('Smart questions generation in progress', 'processing');
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3"></div>
                            <span>Generating intelligent questions from document content...</span>
                        </div>
                    </div>
                `;
                
                try {
                    let response;
                    let filename = '';
                    
                    if (file) {
                        filename = file.name;
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('action', 'smart_questions');
                        response = await fetch('/upload', {
                            method: 'POST',
                            body: formData
                        });
                    } else {
                        response = await fetch('/process-text', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                document_id: selectedDoc, 
                                action: 'smart_questions',
                                question_types: ['analytical', 'critical_thinking', 'comprehension', 'application']
                            })
                        });
                        filename = 'Selected Document';
                    }
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.task_id) {
                            this.monitorTask(result.task_id, filename);
                        } else if (result.result || result.questions) {
                            const questions = result.result || result.questions;
                            this.displaySmartQuestions(questions, filename, resultsDiv);
                            this.addNotification('Smart questions generated', 'success', 'Questions');
                            this.addProgressItem('Smart questions completed', 'completed');
                        }
                    } else {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                } catch (error) {
                    console.error('Questions generation error:', error);
                    this.addNotification('Questions generation failed', 'error', 'Questions');
                    this.addProgressItem('Questions generation failed', 'error');
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to generate questions: ${error.message}
                        </div>
                    `;
                }
            }

            async generateBlogPost() {
                const postType = document.getElementById('blogPostType').value;
                const topic = document.getElementById('blogTopic').value;
                const docSelect = document.getElementById('docSelectBlog');
                const fileInput = document.getElementById('uploadBlog');
                const resultsDiv = document.getElementById('blogResults');
                
                if (!topic && !docSelect.value && !fileInput.files[0]) {
                    resultsDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Please provide a topic or select a document.</div>';
                    return;
                }
                
                this.addNotification(`Generating ${postType}...`, 'info', 'Blog');
                this.addProgressItem(`${postType} generation in progress`, 'processing');
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3"></div>
                            <span>Creating ${postType}... This may take a moment.</span>
                        </div>
                    </div>
                `;
                
                try {
                    let response;
                    let filename = topic || 'Blog Content';
                    
                    if (fileInput.files[0]) {
                        // Generate from uploaded file
                        const formData = new FormData();
                        formData.append('file', fileInput.files[0]);
                        formData.append('action', 'blog_generation');
                        formData.append('blog_type', postType);
                        formData.append('topic', topic);
                        response = await fetch('/upload', {
                            method: 'POST',
                            body: formData
                        });
                        filename = fileInput.files[0].name;
                    } else {
                        // Generate from topic or existing document
                        response = await fetch('/process-text', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                document_id: docSelect.value,
                                text: topic,
                                action: 'blog_generation',
                                blog_type: postType,
                                topic: topic,
                                user_id: 'user'
                            })
                        });
                    }
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Blog generation response:', result);
                        
                        if (result.task_id) {
                            this.monitorTask(result.task_id, filename);
                        } else if (result.result || result.content) {
                            const content = result.result || result.content;
                            this.displayBlogContent(content, postType, resultsDiv);
                            this.addNotification(`${postType} generated successfully`, 'success', 'Blog');
                            this.addProgressItem(`${postType} generation completed`, 'completed');
                        }
                    } else {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                } catch (error) {
                    console.error('Blog generation error:', error);
                    this.addNotification('Blog generation failed', 'error', 'Blog');
                    this.addProgressItem('Blog generation failed', 'error');
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to generate ${postType}: ${error.message}
                        </div>
                    `;
                }
            }
        }

        // Voice Command Functions
        async function toggleVoiceCommand() {
            const btn = document.getElementById('voiceBtn');
            const icon = document.getElementById('voiceBtnIcon');
            const status = document.getElementById('voiceStatus');
            const center = document.getElementById('voiceCommandCenter');
            
            if (!window.dashboard.isVoiceActive) {
                // Start voice with real processor
                if (window.dashboard.voiceProcessor) {
                    try {
                        await window.dashboard.voiceProcessor.startRecording();
                        btn.classList.add('recording');
                        icon.className = 'fas fa-stop';
                        status.innerHTML = '<div>🎙️ AI Listening...</div><small class="text-muted">Speak naturally</small>';
                        center.classList.add('active');
                        window.dashboard.isVoiceActive = true;
                        window.dashboard.showNotification('🎙️ Voice AI activated - Whisper processing enabled');
                        
                        // Setup transcription event listeners
                        window.addEventListener('transcriptionResult', handleTranscriptionResult);
                    } catch (error) {
                        console.error('Failed to start voice recording:', error);
                        window.dashboard.showNotification('❌ Voice activation failed - check microphone permissions');
                    }
                } else {
                    // Fallback to basic mode
                    btn.classList.add('recording');
                    icon.className = 'fas fa-stop';
                    status.innerHTML = '<div>Listening...</div><small class="text-muted">Basic mode - upgrade to Whisper</small>';
                    center.classList.add('active');
                    window.dashboard.isVoiceActive = true;
                    window.dashboard.showNotification('Voice AI activated - basic mode');
                }
            } else {
                // Stop voice
                if (window.dashboard.voiceProcessor) {
                    try {
                        await window.dashboard.voiceProcessor.stopRecording();
                        window.removeEventListener('transcriptionResult', handleTranscriptionResult);
                    } catch (error) {
                        console.warn('Error stopping voice processor:', error);
                    }
                }
                
                btn.classList.remove('recording');
                icon.className = 'fas fa-microphone';
                status.innerHTML = '<div>Voice AI Ready</div><small class="text-muted">Click to start conversation</small>';
                center.classList.remove('active');
                window.dashboard.isVoiceActive = false;
                window.dashboard.showNotification('✅ Voice AI conversation saved');
            }
        }

        function handleTranscriptionResult(event) {
            const result = event.detail;
            console.log('📝 Transcription result:', result);
            
            // Add to transcript buffer
            window.dashboard.transcriptBuffer.push({
                text: result.text,
                timestamp: new Date(),
                confidence: result.confidence || 0.85
            });
            
            // Update live workspace
            updateLiveTranscript(result.text);
            
            // Process as command if it looks like one
            if (result.text.toLowerCase().includes('command') || 
                result.text.toLowerCase().includes('create') ||
                result.text.toLowerCase().includes('show') ||
                result.text.toLowerCase().includes('open')) {
                window.dashboard.processCommand(result.text);
            }
        }

        function updateLiveTranscript(text) {
            const transcriptArea = document.querySelector('#activeDocument .p-3');
            if (transcriptArea) {
                const timestamp = new Date().toLocaleTimeString();
                const newEntry = `<p class="mb-2"><strong>You:</strong> "${text}" <small class="text-muted">${timestamp}</small></p>`;
                transcriptArea.innerHTML += newEntry;
                transcriptArea.scrollTop = transcriptArea.scrollHeight;
            }
        }

        function saveTranscript() {
            if (window.dashboard.transcriptBuffer.length > 0) {
                const transcript = window.dashboard.transcriptBuffer.map(item => 
                    `[${item.timestamp.toLocaleTimeString()}] ${item.text}`
                ).join('\n');
                
                // Save to backend
                fetch('/save-transcript', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transcript: transcript,
                        timestamp: new Date().toISOString(),
                        context: window.dashboard.currentContext
                    })
                }).then(response => {
                    if (response.ok) {
                        window.dashboard.showNotification('✅ Transcript saved successfully');
                    } else {
                        window.dashboard.showNotification('⚠️ Transcript saved locally');
                    }
                });
            } else {
                window.dashboard.showNotification('No transcript to save');
            }
        }

        function shareWorkspace() {
            const workspaceData = {
                transcript: window.dashboard.transcriptBuffer,
                documents: Array.from(window.dashboard.documents.values()),
                context: window.dashboard.currentContext,
                timestamp: new Date().toISOString()
            };
            
            fetch('/share-workspace', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(workspaceData)
            }).then(response => {
                if (response.ok) {
                    window.dashboard.showNotification('✅ Workspace shared with team');
                } else {
                    window.dashboard.showNotification('⚠️ Share functionality coming soon');
                }
            });
        }

        async function aiSummarize() {
            window.dashboard.showNotification('🤖 AI is analyzing and generating summary...');
            
            const data = {
                transcript: window.dashboard.transcriptBuffer,
                documents: Array.from(window.dashboard.documents.values()),
                context: window.dashboard.currentContext
            };
            
            try {
                const response = await fetch('/ai-summarize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const summary = await response.json();
                    displayAISummary(summary);
                    window.dashboard.showNotification('✅ AI summary generated');
                } else {
                    window.dashboard.showNotification('⚠️ AI summary service temporarily unavailable');
                }
            } catch (error) {
                console.error('AI summarize error:', error);
                window.dashboard.showNotification('❌ AI summary failed');
            }
        }

        function displayAISummary(summary) {
            const summaryHtml = `
                <div class="insight-card context-highlight">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-magic text-success me-3"></i>
                        <h6 class="mb-0">AI Generated Summary</h6>
                    </div>
                    <p class="small mb-2">${summary.summary}</p>
                    <div class="small text-muted">
                        <strong>Key Points:</strong>
                        <ul class="ps-3 mb-0">
                            ${summary.keyPoints.map(point => `<li>${point}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            const insightsPanel = document.querySelector('.ai-insights .glass-card');
            if (insightsPanel) {
                insightsPanel.insertAdjacentHTML('beforeend', summaryHtml);
            }
        }

        // File upload handling
        function setupFileUpload() {
            const commandInput = document.getElementById('commandInput');
            
            // Drag and drop
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                document.body.style.opacity = '0.8';
            });
            
            document.addEventListener('dragleave', (e) => {
                if (!e.relatedTarget) {
                    document.body.style.opacity = '1';
                }
            });
            
            document.addEventListener('drop', (e) => {
                e.preventDefault();
                document.body.style.opacity = '1';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
        }

        async function handleFileUpload(file) {
            window.dashboard.showNotification(`📁 Uploading ${file.name}...`);
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('action', 'document_analysis');
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Add to documents map
                    window.dashboard.documents.set(result.task_id, {
                        id: result.task_id,
                        name: file.name,
                        size: file.size,
                        uploadTime: new Date(),
                        status: 'processing',
                        progress: 0
                    });
                    
                    // Store task ID for later checking
                    let recentTasks = JSON.parse(localStorage.getItem('recentTaskIds') || '[]');
                    recentTasks.unshift({ taskId: result.task_id, filename: file.name, timestamp: new Date().toISOString() });
                    recentTasks = recentTasks.slice(0, 10); // Keep last 10 tasks
                    localStorage.setItem('recentTaskIds', JSON.stringify(recentTasks));
                    
                    // Show upload success
                    window.dashboard.addNotification(`${file.name} uploaded and processing started`, 'success', 'File Upload');
                    window.dashboard.addProgressItem(`Uploading ${file.name}`, 'completed');
                    window.dashboard.addProgressItem(`Processing ${file.name}`, 'processing');
                    
                    // Display in workspace immediately
                    const workArea = document.querySelector('#activeWorkArea');
                    if (workArea) {
                        workArea.innerHTML = `
                            <div class="processing-display">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-file-upload me-3" style="font-size: 2rem; color: var(--info-color);"></i>
                                        <div>
                                            <h4 style="color: var(--text-primary); margin: 0;">Processing Document</h4>
                                            <p style="color: var(--text-secondary); margin: 0;">${file.name}</p>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary btn-sm" onclick="window.dashboard.refreshAnalysisResults()">
                                            <i class="fas fa-sync me-1"></i>Check Status
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="window.dashboard.clearWorkspace()">
                                            <i class="fas fa-times me-1"></i>Close
                                        </button>
                                    </div>
                                </div>
                                <div class="processing-status" style="background: var(--surface-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="spinner-border spinner-border-sm me-3" style="color: var(--info-color);"></div>
                                        <span style="color: var(--text-primary); font-weight: 500;">Analyzing uploaded document...</span>
                                    </div>
                                    <div class="progress mb-3" style="height: 8px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 25%; background: var(--info-color);"></div>
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                        <div>📊 File size: ${(file.size / 1024 / 1024).toFixed(1)}MB</div>
                                        <div>⏱️ Started: ${new Date().toLocaleTimeString()}</div>
                                        <div>🔍 Task ID: ${result.task_id}</div>
                                    </div>
                                    <div class="mt-3 p-3" style="background: var(--card-bg); border-radius: 8px; border-left: 3px solid var(--info-color);">
                                        <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 8px;">💡 What's happening:</div>
                                        <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                                            Your document is being processed by our AI engine. This includes text extraction, content analysis, and insight generation. Results will appear here once processing is complete.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Start monitoring task progress
                    window.dashboard.monitorTask(result.task_id, file.name);
                    
                    // Refresh document list
                    window.dashboard.loadRealDocuments();
                } else {
                    const error = await response.text();
                    window.dashboard.addNotification(`Upload failed: ${error}`, 'error', 'Upload Error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                window.dashboard.addNotification(`Upload error: ${error.message}`, 'error', 'Upload Error');
            }
        }

        function updateDocumentsDisplay() {
            const docArea = document.querySelector('#activeDocument');
            if (docArea && window.dashboard.documents.size > 0) {
                const docsHtml = Array.from(window.dashboard.documents.values()).map(doc => `
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-file-alt text-primary me-3"></i>
                        <span>${doc.name}</span>
                        <span class="ms-auto text-muted">${(doc.size / 1024 / 1024).toFixed(1)}MB</span>
                    </div>
                `).join('');
                
                docArea.querySelector('.mb-3:nth-child(2) .p-3').innerHTML = docsHtml;
            }
        }

        // Initialize dashboard
        window.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new SmartDashboard();
            setupFileUpload();
            
            // Initialize notification and progress systems
            window.dashboard.updateNotificationBadge();
            window.dashboard.refreshNotificationPanel();
            window.dashboard.refreshProgressConsole();
            
            // Show welcome notification
            setTimeout(() => {
                window.dashboard.addNotification('Welcome to your Unified Intelligence Workspace', 'success', 'Welcome');
                window.dashboard.addProgressItem('Dashboard initialized successfully', 'completed');
                
                // Check for any completed tasks on startup
                window.dashboard.refreshAnalysisResults();
            }, 1000);
            
            // Setup keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'k':
                            e.preventDefault();
                            document.getElementById('commandInput').focus();
                            break;
                        case 's':
                            e.preventDefault();
                            saveTranscript();
                            break;
                        case 'Enter':
                            if (e.shiftKey) {
                                e.preventDefault();
                                toggleVoiceCommand();
                            }
                            break;
                    }
                }
            });
        });
    </script>
    
    </div> <!-- End Main Content -->

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <h6 class="mb-0" style="color: var(--text-primary);">Notifications</h6>
            <button class="btn btn-sm btn-link p-0" onclick="window.dashboard.toggleNotificationPanel()" style="color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notification-list" id="notificationList">
            <div class="text-center py-4">
                <i class="fas fa-bell-slash" style="color: var(--text-muted); font-size: 2rem;"></i>
                <p style="color: var(--text-muted); margin-top: 12px;">No notifications yet</p>
            </div>
        </div>
        <div class="notification-header" style="border-top: 1px solid var(--border-color); border-bottom: none;">
            <button class="btn btn-sm btn-outline-primary" onclick="window.dashboard.clearAllNotifications()">
                <i class="fas fa-check-double me-1"></i>Clear All
            </button>
        </div>
    </div>

    <!-- Progress Console -->
    <div class="progress-console" id="progressConsole">
        <div class="console-header">
            <h6 class="mb-0" style="color: var(--text-primary);">Activity Progress</h6>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-link p-0" onclick="window.dashboard.toggleProgressConsole()" style="color: var(--text-secondary);" title="Toggle Console">
                    <i class="fas fa-window-minimize"></i>
                </button>
                <button class="btn btn-sm btn-link p-0" onclick="window.dashboard.clearProgressConsole()" style="color: var(--text-secondary);" title="Clear Console">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="console-content" id="consoleContent">
            <div class="text-center py-3">
                <i class="fas fa-list-ul" style="color: var(--text-muted); font-size: 1.5rem;"></i>
                <p style="color: var(--text-muted); margin-top: 8px; font-size: 14px;">Activity will appear here</p>
            </div>
        </div>
    </div>

</body>
</html>